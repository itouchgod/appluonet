# æƒé™è°ƒè¯•è®°å½•

## é—®é¢˜æè¿°
1. åˆæ¬¡ç™»å½•æ—¶ï¼Œæƒé™æ­£ç¡®æ˜¾ç¤º
2. ä¿®æ”¹æƒé™åï¼Œé¡µé¢åˆ·æ–°æ— æ³•è·å–æ–°æƒé™
3. æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜åé‡æ–°ç™»å½•ï¼Œæƒé™æ­£ç¡®æ˜¾ç¤º
4. æƒé™åˆ·æ–°åŠŸèƒ½ä¸ç¨³å®š

## æ ¹æœ¬åŸå› 
NextAuthçš„sessionç¼“å­˜é—®é¢˜ï¼š
- åˆæ¬¡ç™»å½•æ—¶ï¼Œä»æ•°æ®åº“è·å–æœ€æ–°æƒé™
- ä¿®æ”¹æƒé™åï¼Œsessionä»ç„¶ä½¿ç”¨ç¼“å­˜æ•°æ®
- æ¸…ç©ºç¼“å­˜åé‡æ–°ç™»å½•ï¼Œé‡æ–°ä»æ•°æ®åº“è·å–æƒé™

## è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥sessionçŠ¶æ€
```javascript
// åœ¨dashboardé¡µé¢æ·»åŠ è°ƒè¯•ä¿¡æ¯
console.log('SessionçŠ¶æ€:', {
  hasSession: !!session,
  sessionUser: session?.user?.name,
  sessionStatus: status
});
console.log('Sessionç”¨æˆ·æƒé™:', session?.user?.permissions);
```

### 2. æ£€æŸ¥æƒé™storeçŠ¶æ€
```javascript
// åœ¨permissions.tsä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
console.log('è·å–ç”¨æˆ·æƒé™æˆåŠŸ:', {
  username: userData.username,
  permissions: userData.permissions,
  isAdmin: userData.isAdmin
});
```

### 3. æ£€æŸ¥æƒé™æ˜ å°„
```javascript
// åœ¨dashboardé¡µé¢æ£€æŸ¥æƒé™æ˜ å°„
console.log('æƒé™æ˜ å°„æ›´æ–°:', {
  user: user?.username,
  userPermissions: user?.permissions,
  permissions: permissionMap,
  documentTypePermissions: permissionMap.documentTypePermissions,
  accessibleDocumentTypes: permissionMap.accessibleDocumentTypes
});
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¼ºåˆ¶é‡æ–°ç™»å½•ï¼ˆæ¨èï¼‰
```javascript
// æƒé™åˆ·æ–°æ—¶å¼ºåˆ¶é‡æ–°ç™»å½•
await signOut({ redirect: false });
setTimeout(async () => {
  await signIn('credentials', {
    username: session?.user?.username,
    password: 'dummy',
    redirect: false
  });
  await fetchUser();
}, 1000);
```

### æ–¹æ¡ˆ2ï¼šç›´æ¥ä»æ•°æ®åº“è·å–æƒé™
```javascript
// åˆ›å»ºä¸“é—¨çš„APIç«¯ç‚¹è·å–æœ€æ–°æƒé™
const response = await fetch('/api/auth/get-latest-permissions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
});
```

### æ–¹æ¡ˆ3ï¼šæ¸…é™¤sessionç¼“å­˜
```javascript
// å¼ºåˆ¶åˆ·æ–°session
const response = await fetch('/api/auth/session', {
  headers: {
    'Cache-Control': 'no-cache',
    'Pragma': 'no-cache'
  }
});
```

## å…³é”®è°ƒè¯•ç‚¹

### 1. SessionåŠ è½½çŠ¶æ€
- `status === 'loading'` - sessionæ­£åœ¨åŠ è½½
- `status === 'authenticated'` - å·²è®¤è¯
- `status === 'unauthenticated'` - æœªè®¤è¯

### 2. æƒé™æ•°æ®æ ¼å¼
- å­—ç¬¦ä¸²æ•°ç»„ï¼š`['quotation', 'packing']`
- å¯¹è±¡æ•°ç»„ï¼š`[{moduleId: 'quotation', canAccess: true}]`
- å¯¹è±¡æ ¼å¼ï¼š`{quotation: true, packing: false}`

### 3. æƒé™æ£€æŸ¥é€»è¾‘
```javascript
hasPermission: (moduleId: string) => {
  const { user } = get();
  if (!user?.permissions) return false;
  
  const permission = user.permissions.find(p => p.moduleId === moduleId);
  return permission?.canAccess || false;
}
```

## æµ‹è¯•æ­¥éª¤

### 1. åŸºç¡€æµ‹è¯•
1. æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜
2. ç™»å½•ç”¨æˆ·
3. æ£€æŸ¥æƒé™æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

### 2. æƒé™ä¿®æ”¹æµ‹è¯•
1. åœ¨åå°ä¿®æ”¹ç”¨æˆ·æƒé™
2. å›åˆ°dashboardé¡µé¢
3. ç‚¹å‡»åˆ·æ–°æƒé™æŒ‰é’®
4. æ£€æŸ¥æ˜¯å¦è·å–åˆ°æ–°æƒé™

### 3. é¡µé¢åˆ·æ–°æµ‹è¯•
1. ä¿®æ”¹æƒé™å
2. åˆ·æ–°dashboardé¡µé¢
3. æ£€æŸ¥æƒé™æ˜¯å¦æ›´æ–°

## å¸¸è§é—®é¢˜

### 1. 500é”™è¯¯
- æ£€æŸ¥APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- æ£€æŸ¥ç¯å¢ƒå˜é‡

### 2. 401é”™è¯¯
- æ£€æŸ¥sessionçŠ¶æ€
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•

### 3. æƒé™ä¸æ›´æ–°
- æ£€æŸ¥sessionç¼“å­˜
- æ£€æŸ¥æƒé™æ•°æ®æ ¼å¼
- æ£€æŸ¥æƒé™æ˜ å°„é€»è¾‘

## æ€§èƒ½é—®é¢˜åˆ†æ

### å½“å‰å­˜åœ¨çš„æ€§èƒ½é—®é¢˜
1. **ç™»å½•æ—¶é—´è¿‡é•¿** - `login_request: 2428.80ms`
2. **DashboardåŠ è½½æ…¢** - `dashboard_page_load: 3203.30ms`
3. **å¤šæ¬¡æƒé™æ˜ å°„æ›´æ–°** - é‡å¤è®¡ç®—æƒé™æ˜ å°„
4. **Sessionå›è°ƒæ€§èƒ½** - æ¯æ¬¡éƒ½ä»æ•°æ®åº“è·å–æƒé™

### æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
1. **å‡å°‘APIè°ƒç”¨** - åˆå¹¶æƒé™è·å–è¯·æ±‚
2. **ç¼“å­˜ä¼˜åŒ–** - é€‚å½“çš„æƒé™ç¼“å­˜æœºåˆ¶
3. **å‡å°‘é‡å¤è®¡ç®—** - ä¼˜åŒ–æƒé™æ˜ å°„é€»è¾‘
4. **å¼‚æ­¥åŠ è½½** - æƒé™æ•°æ®å¼‚æ­¥è·å–

## æœ€ä½³å®è·µä¸ä¼˜åŒ–è¦ç‚¹

### 1. æƒé™åˆ·æ–°æœºåˆ¶ä¼˜åŒ–
- **é¿å…å¼ºåˆ¶é‡æ–°ç™»å½•** - ä¸ä½¿ç”¨å¼ºåˆ¶é‡æ–°ç™»å½•çš„æ–¹æ¡ˆï¼Œæ”¹ç”¨ç›´æ¥åˆ·æ–°æƒé™
- **æ‰‹åŠ¨åˆ·æ–°æœºåˆ¶** - ç”¨æˆ·å¯ä»¥é€šè¿‡èœå•ä¸­çš„"åˆ·æ–°æƒé™"æŒ‰é’®ä¸»åŠ¨è·å–æœ€æ–°æƒé™
- **ä¿æŒç”¨æˆ·çŠ¶æ€** - åˆ·æ–°æƒé™æ—¶ä¿æŒå½“å‰ç”¨æˆ·çŠ¶æ€ï¼Œé¿å…ä¸å¿…è¦çš„çŠ¶æ€é‡ç½®

### 2. æƒé™æ•°æ®è·å–ä¼˜åŒ–
- **ç›´æ¥æ•°æ®åº“è®¿é—®** - ä»æ•°æ®åº“ç›´æ¥è·å–æœ€æ–°æƒé™ï¼Œé¿å…sessionç¼“å­˜é—®é¢˜
- **è¯·æ±‚å¤´ä¼ é€’** - ä½¿ç”¨è¯·æ±‚å¤´ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Œç¡®ä¿æƒé™è·å–çš„å‡†ç¡®æ€§
- **ç¦ç”¨ç¼“å­˜** - æ·»åŠ  cache: 'no-store' ç¡®ä¿æ¯æ¬¡éƒ½è·å–æœ€æ–°æ•°æ®

### 3. çŠ¶æ€ç®¡ç†ä¼˜åŒ–
- **é¿å…ä¸­é—´çŠ¶æ€** - è®¾ç½®loadingçŠ¶æ€æ—¶ä¿ç•™å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å…undefinedçŠ¶æ€
- **å¢é‡æ›´æ–°** - åªæ›´æ–°permissionså­—æ®µï¼Œä¿ç•™å…¶ä»–ç”¨æˆ·ä¿¡æ¯
- **çŠ¶æ€ä¾èµ–ä¼˜åŒ–** - ç§»é™¤ä¸å¿…è¦çš„çŠ¶æ€ä¾èµ–ï¼Œå‡å°‘é‡å¤è®¡ç®—

### 4. Reactæ€§èƒ½ä¼˜åŒ–
- **ä¾èµ–é¡¹ä¼˜åŒ–** - åªä¾èµ–hasPermissionå‡½æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨è·å–æœ€æ–°æƒé™çŠ¶æ€
- **é¿å…é‡å¤æ¸²æŸ“** - ç§»é™¤user?.permissionså’ŒrefreshKeyä¾èµ–
- **çŠ¶æ€ç¨³å®šæ€§** - ä¿æŒç”¨æˆ·ç•Œé¢ç¨³å®šï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

### 5. é”™è¯¯å¤„ç†ä¸ç›‘æ§
- **å®Œå–„é”™è¯¯å¤„ç†** - æ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’ŒçŠ¶æ€ç 
- **è°ƒè¯•ä¿¡æ¯** - ä¿ç•™å…³é”®è°ƒè¯•ä¿¡æ¯ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥
- **æ€§èƒ½ç›‘æ§** - ç›‘æ§æƒé™è·å–æ€§èƒ½ï¼Œä¼˜åŒ–å“åº”æ—¶é—´

### 6. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **å³æ—¶åé¦ˆ** - æä¾›æ¸…æ™°çš„æƒé™åˆ·æ–°çŠ¶æ€åé¦ˆ
- **çŠ¶æ€æŒ‡ç¤º** - æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œé¿å…é‡å¤ç‚¹å‡»
- **é”™è¯¯æç¤º** - å‹å¥½çš„é”™è¯¯æç¤ºï¼ŒæŒ‡å¯¼ç”¨æˆ·æ“ä½œ

## å…³é”®é—®é¢˜å‘ç°ä¸è§£å†³

### é—®é¢˜1ï¼šæƒé™æ•°æ®åŠ è½½æ—¶åºé—®é¢˜
**ç°è±¡**ï¼šç™»å½•åæƒé™æ£€æŸ¥å¤±è´¥ï¼Œuserä¸ºnull
**åŸå› **ï¼šæƒé™æ•°æ®è¿˜æ²¡æœ‰å®Œå…¨åŠ è½½å®Œæˆå°±å¼€å§‹è¿›è¡Œæƒé™æ£€æŸ¥
**è§£å†³**ï¼š
```javascript
// åœ¨æƒé™æ˜ å°„ä¸­æ·»åŠ åŠ è½½çŠ¶æ€æ£€æŸ¥
if (!user || isLoading) {
  return {
    permissions: { quotation: false, packing: false, ... },
    documentTypePermissions: { quotation: false, ... },
    accessibleDocumentTypes: []
  };
}
```

### é—®é¢˜2ï¼šæƒé™æ•°æ®æ ¼å¼å¤„ç†
**ç°è±¡**ï¼šæƒé™æ•°æ®è·å–æˆåŠŸä½†æ˜¾ç¤ºä¸æ­£ç¡®
**åŸå› **ï¼šæƒé™æ•°æ®æ˜¯å¯¹è±¡æ•°ç»„æ ¼å¼ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
**è§£å†³**ï¼š
```javascript
// ä¸“é—¨å¤„ç†å¯¹è±¡æ•°ç»„æ ¼å¼çš„æƒé™
const permission = user.permissions.find(p => 
  p.moduleId === moduleId || 
  (moduleId === 'confirmation' && p.moduleId === 'quotation')
);
return permission?.canAccess || false;
```

### é—®é¢˜3ï¼šæƒé™æ£€æŸ¥ä¾èµ–å…³ç³»
**ç°è±¡**ï¼šæƒé™æ›´æ–°åç•Œé¢ä¸åˆ·æ–°
**åŸå› **ï¼šæƒé™æ˜ å°„çš„ä¾èµ–é¡¹è®¾ç½®ä¸å½“
**è§£å†³**ï¼š
```javascript
// æ·»åŠ æ­£ç¡®çš„ä¾èµ–é¡¹
}, [user, isLoading, hasPermission]);
```

### é—®é¢˜4ï¼šè°ƒè¯•ä¿¡æ¯ä¸è¶³
**ç°è±¡**ï¼šé—®é¢˜éš¾ä»¥å®šä½
**åŸå› **ï¼šç¼ºå°‘è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
**è§£å†³**ï¼š
```javascript
// æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
if (process.env.NODE_ENV === 'development') {
  console.log('æƒé™æ£€æŸ¥:', { moduleId, hasAccess, permission, allPermissions: user.permissions });
}
```

## å½“å‰çŠ¶æ€æ€»ç»“

### âœ… å·²è§£å†³çš„é—®é¢˜
- æƒé™åˆ·æ–°åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œæ— éœ€å¼ºåˆ¶é‡æ–°ç™»å½•
- ä¿®æ”¹æƒé™åå¯ä»¥é€šè¿‡èœå•æ‰‹åŠ¨åˆ·æ–°
- æƒé™åˆ·æ–°æ—¶ä¸ä¼šå‡ºç°undefinedçŠ¶æ€
- é¿å…äº†ä¸å¿…è¦çš„ç»„ä»¶é‡æ–°æ¸²æŸ“
- ä¼˜åŒ–äº†æƒé™æ˜ å°„çš„ä¾èµ–å…³ç³»
- æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- **è§£å†³äº†æƒé™æ•°æ®åŠ è½½æ—¶åºé—®é¢˜** - ç¡®ä¿åœ¨æƒé™æ•°æ®å®Œå…¨åŠ è½½åå†è¿›è¡Œæƒé™æ£€æŸ¥
- **ä¿®å¤äº†æƒé™æ˜¾ç¤ºé—®é¢˜** - æ­£ç¡®å¤„ç†å¯¹è±¡æ•°ç»„æ ¼å¼çš„æƒé™æ•°æ®
- **ä¼˜åŒ–äº†æƒé™æ£€æŸ¥é€»è¾‘** - æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å’Œé”™è¯¯å¤„ç†

### âš ï¸ éœ€è¦æŒç»­å…³æ³¨çš„é—®é¢˜
- ç›‘æ§æƒé™åˆ·æ–°çš„æ€§èƒ½è¡¨ç°
- è§‚å¯Ÿç”¨æˆ·ä½¿ç”¨ä½“éªŒåé¦ˆ
- å…³æ³¨æƒé™ç¼“å­˜çš„æœ‰æ•ˆæœŸè®¾ç½®
- ç›‘æ§æƒé™æ•°æ®åŠ è½½çš„æ—¶åºé—®é¢˜
- å…³æ³¨æƒé™æ£€æŸ¥çš„æ€§èƒ½å½±å“

### ğŸ¯ åç»­ä¼˜åŒ–æ–¹å‘
1. è€ƒè™‘æ·»åŠ æƒé™å˜æ›´çš„websocketé€šçŸ¥
2. ä¼˜åŒ–æƒé™æ•°æ®çš„æ ¼å¼å’Œä¼ è¾“
3. æ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡
4. å®Œå–„æƒé™å˜æ›´çš„æ—¥å¿—è®°å½•
5. è€ƒè™‘æ·»åŠ æƒé™é¢„åŠ è½½æœºåˆ¶
6. ä¼˜åŒ–æƒé™æ£€æŸ¥çš„ç¼“å­˜ç­–ç•¥

## æœ€ä½³å®è·µæ€»ç»“

### 1. æƒé™æ•°æ®åŠ è½½
- **æ—¶åºæ§åˆ¶**ï¼šç¡®ä¿æƒé™æ•°æ®å®Œå…¨åŠ è½½åå†è¿›è¡Œæƒé™æ£€æŸ¥
- **çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨loadingçŠ¶æ€é¿å…è¿‡æ—©çš„æƒé™åˆ¤æ–­
- **é”™è¯¯å¤„ç†**ï¼šä¸ºæƒé™åŠ è½½å¤±è´¥æä¾›å‹å¥½çš„é”™è¯¯æç¤º

### 2. æƒé™æ•°æ®æ ¼å¼
- **æ ¼å¼ç»Ÿä¸€**ï¼šç¡®ä¿æƒé™æ•°æ®æ ¼å¼çš„ä¸€è‡´æ€§
- **ç±»å‹æ£€æŸ¥**ï¼šæ·»åŠ ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥é¿å…è¿è¡Œæ—¶é”™è¯¯
- **ç‰¹æ®Šå¤„ç†**ï¼šä¸ºç‰¹æ®Šæƒé™ï¼ˆå¦‚é”€å”®ç¡®è®¤ï¼‰æä¾›ä¸“é—¨çš„å¤„ç†é€»è¾‘

### 3. Reactæ€§èƒ½ä¼˜åŒ–
- **ä¾èµ–ç®¡ç†**ï¼šæ­£ç¡®è®¾ç½®useMemoå’ŒuseCallbackçš„ä¾èµ–é¡¹
- **çŠ¶æ€æ›´æ–°**ï¼šé¿å…ä¸å¿…è¦çš„çŠ¶æ€æ›´æ–°å’Œé‡æ–°æ¸²æŸ“
- **æ¡ä»¶æ¸²æŸ“**ï¼šåœ¨æ•°æ®æœªå‡†å¤‡å¥½æ—¶æä¾›åˆé€‚çš„é»˜è®¤çŠ¶æ€

### 4. è°ƒè¯•ä¸ç›‘æ§
- **è¯¦ç»†æ—¥å¿—**ï¼šæ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ä¾¿äºé—®é¢˜æ’æŸ¥
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æƒé™æ£€æŸ¥çš„æ€§èƒ½å½±å“
- **é”™è¯¯è¿½è¸ª**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 5. ç”¨æˆ·ä½“éªŒ
- **åŠ è½½çŠ¶æ€**ï¼šæä¾›æ¸…æ™°çš„åŠ è½½çŠ¶æ€æŒ‡ç¤º
- **å³æ—¶åé¦ˆ**ï¼šæƒé™å˜æ›´åæä¾›å³æ—¶çš„ç”¨æˆ·åé¦ˆ
- **é”™è¯¯æ¢å¤**ï¼šæä¾›æƒé™åŠ è½½å¤±è´¥åçš„æ¢å¤æœºåˆ¶ 

## æœ€æ–°ä¿®å¤ - æ€§èƒ½ç›‘æ§ç¦ç”¨ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
å³ä½¿ä¿®å¤äº† useMemo ä¾èµ–é¡¹ï¼Œç”¨æˆ·ä»ç„¶æŠ¥å‘Šï¼š
- é¢‘ç¹çš„ `page_load` è®¡æ—¶å™¨å¯åŠ¨
- å¤§é‡çš„ `/api/auth/session` è¯·æ±‚
- åº”ç”¨ç¨‹åºä»ç„¶é™·å…¥æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯

### æ ¹æœ¬åŸå› åˆ†æ
ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°æ€§èƒ½ç›‘æ§ç³»ç»Ÿæ˜¯å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“çš„ä¸»è¦åŸå› ï¼š
1. **æ€§èƒ½ç›‘æ§ useEffect**: å³ä½¿ç§»é™¤äº† `user` ä¾èµ–ï¼Œæ¡ä»¶æ£€æŸ¥ä»ç„¶åŒ…å« `user`
2. **æ€§èƒ½ç›‘æ§å¯åŠ¨**: åˆå§‹çš„æ€§èƒ½ç›‘æ§å¯åŠ¨ä¹Ÿå¯èƒ½å¯¼è‡´é—®é¢˜
3. **è®¡æ—¶å™¨å†²çª**: `performanceMonitor.startTimer` å’Œ `endTimer` çš„è°ƒç”¨æ—¶æœºä¸å½“

### ä¿®å¤æªæ–½

#### 1. å®Œå…¨ç¦ç”¨æ€§èƒ½ç›‘æ§
```typescript
// ä¿®å¤å‰ - æ€§èƒ½ç›‘æ§å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“
useEffect(() => {
  if (mounted && !refreshing) {
    performanceMonitor.endTimer('dashboard_page_load');
    // ...
  }
}, [mounted, refreshing]);

// ä¿®å¤å - å®Œå…¨ç¦ç”¨æ€§èƒ½ç›‘æ§
// useEffect(() => {
//   if (mounted && !refreshing) {
//     performanceMonitor.endTimer('dashboard_page_load');
//     // ...
//   }
// }, [mounted, refreshing]);
```

#### 2. ç¦ç”¨æ€§èƒ½ç›‘æ§å¯åŠ¨
```typescript
// ä¿®å¤å‰ - æ€§èƒ½ç›‘æ§å¯åŠ¨å¯èƒ½å¯¼è‡´é—®é¢˜
useEffect(() => {
  if (typeof window !== 'undefined') {
    performanceMonitor.startTimer('dashboard_page_load');
    // ...
  }
}, []);

// ä¿®å¤å - å®Œå…¨ç¦ç”¨æ€§èƒ½ç›‘æ§å¯åŠ¨
// useEffect(() => {
//   if (typeof window !== 'undefined') {
//     performanceMonitor.startTimer('dashboard_page_load');
//     // ...
//   }
// }, []);
```

#### 3. ç§»é™¤ refreshKey ä¾èµ–
```typescript
// ä¿®å¤å‰ - refreshKey å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯
}, [permissionMap.documentTypePermissions, refreshKey]);

// ä¿®å¤å - ç§»é™¤ refreshKey ä¾èµ–
}, [permissionMap.documentTypePermissions]);
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ç¦ç”¨æ€§èƒ½ç›‘æ§ï¼Œç§»é™¤ refreshKey ä¾èµ–

### éªŒè¯ç»“æœ
- âœ… æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
- âœ… æ¶ˆé™¤äº†é¢‘ç¹çš„ `page_load` è®¡æ—¶å™¨å¯åŠ¨
- âœ… å‡å°‘äº† `/api/auth/session` è¯·æ±‚
- âœ… åº”ç”¨ç¨‹åºä¸å†é™·å…¥æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯
- âœ… æƒé™ç³»ç»Ÿæ­£å¸¸å·¥ä½œ

### æŠ€æœ¯è¦ç‚¹
1. **æ€§èƒ½ç›‘æ§é—®é¢˜**: æ€§èƒ½ç›‘æ§ç³»ç»Ÿå¯èƒ½æ˜¯å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“çš„ä¸»è¦åŸå› 
2. **ä¾èµ–é¡¹ç¨³å®šæ€§**: å³ä½¿ä¿®å¤äº†ä¾èµ–é¡¹ï¼Œæ€§èƒ½ç›‘æ§çš„è°ƒç”¨æ—¶æœºä»å¯èƒ½å¯¼è‡´é—®é¢˜
3. **ä¸´æ—¶ç¦ç”¨**: åœ¨å¼€å‘é˜¶æ®µæš‚æ—¶ç¦ç”¨æ€§èƒ½ç›‘æ§ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ç¨³å®š
4. **æ¸è¿›å¼ä¿®å¤**: å…ˆç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ç¨³å®šï¼Œå†é€æ­¥æ¢å¤æ€§èƒ½ç›‘æ§

### åç»­è®¡åˆ’
1. **é‡æ–°è®¾è®¡æ€§èƒ½ç›‘æ§**: ä½¿ç”¨æ›´ç¨³å®šçš„æ–¹å¼å®ç°æ€§èƒ½ç›‘æ§
2. **ä¾èµ–é¡¹ä¼˜åŒ–**: è¿›ä¸€æ­¥ä¼˜åŒ–æ‰€æœ‰ useMemo å’Œ useEffect çš„ä¾èµ–é¡¹
3. **æ€§èƒ½ç›‘æ§æ¢å¤**: åœ¨ç¡®ä¿ç¨³å®šçš„åŸºç¡€ä¸Šï¼Œé‡æ–°å¯ç”¨æ€§èƒ½ç›‘æ§

---

## æœ€æ–°ä¿®å¤ - æ— é™é‡æ–°æ¸²æŸ“é—®é¢˜ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šäº†ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼š
- é¢‘ç¹çš„ `[Fast Refresh] rebuilding` æ¶ˆæ¯
- å¤§é‡çš„ `page_load` è®¡æ—¶å™¨é‡å¤å¯åŠ¨
- é¢‘ç¹çš„ `/api/auth/session` è¯·æ±‚
- åº”ç”¨ç¨‹åºé™·å…¥æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯

### æ ¹æœ¬åŸå› åˆ†æ
1. **useMemo ä¾èµ–ä¸ç¨³å®š**: `permissionMap` ä¾èµ– `hasPermission` å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°å¼•ç”¨
2. **æ€§èƒ½ç›‘æ§ useEffect**: ä¾èµ– `user` å¯¹è±¡ï¼Œå¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“
3. **åˆå§‹åŒ– useEffect**: ä¾èµ– `fetchUser` å’Œ `prefetchPages` å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¼•ç”¨ä¸ç¨³å®š

### ä¿®å¤æªæ–½

#### 1. ä¿®å¤æƒé™æ˜ å°„ useMemo
```typescript
// ä¿®å¤å‰ - ä¾èµ– hasPermission å‡½æ•°
const permissionMap = useMemo(() => {
  const permissions = {
    quotation: hasPermission('quotation'),
    packing: hasPermission('packing'),
    // ...
  };
  return { permissions, documentTypePermissions, accessibleDocumentTypes };
}, [user, isLoading, hasPermission]); // hasPermission å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“

// ä¿®å¤å - ç›´æ¥ä½¿ç”¨ç”¨æˆ·æƒé™æ•°æ®
const permissionMap = useMemo(() => {
  const userPermissions = user.permissions || [];
  const hasPermissionDirect = (moduleId: string) => {
    const permission = userPermissions.find(p => p.moduleId === moduleId);
    return permission?.canAccess || false;
  };
  
  const permissions = {
    quotation: hasPermissionDirect('quotation'),
    packing: hasPermissionDirect('packing'),
    // ...
  };
  return { permissions, documentTypePermissions, accessibleDocumentTypes };
}, [user, isLoading]); // ç§»é™¤ hasPermission ä¾èµ–
```

#### 2. ä¿®å¤æ€§èƒ½ç›‘æ§ useEffect
```typescript
// ä¿®å¤å‰ - ä¾èµ– user å¯¹è±¡
useEffect(() => {
  if (mounted && !refreshing && user) {
    performanceMonitor.endTimer('dashboard_page_load');
    // ...
  }
}, [mounted, refreshing, user]); // user å¯¹è±¡å˜åŒ–å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“

// ä¿®å¤å - ç§»é™¤ user ä¾èµ–
useEffect(() => {
  if (mounted && !refreshing && user) {
    performanceMonitor.endTimer('dashboard_page_load');
    // ...
  }
}, [mounted, refreshing]); // ç§»é™¤ user ä¾èµ–
```

#### 3. ä¿®å¤æ¨¡å—è¿‡æ»¤ useMemo
```typescript
// ä¿®å¤å‰ - ä¾èµ– hasPermission å‡½æ•°
const availableToolModules = useMemo(() => {
  return TOOL_MODULES.filter(module => hasPermission(module.id));
}, [user, isLoading, hasPermission]);

// ä¿®å¤å - ç›´æ¥ä½¿ç”¨ç”¨æˆ·æƒé™æ•°æ®
const availableToolModules = useMemo(() => {
  const userPermissions = user.permissions || [];
  return TOOL_MODULES.filter(module => {
    const permission = userPermissions.find(p => p.moduleId === module.id);
    return permission?.canAccess || false;
  });
}, [user, isLoading]);
```

#### 4. ä¿®å¤åˆå§‹åŒ– useEffect
```typescript
// ä¿®å¤å‰ - ä¾èµ–ä¸ç¨³å®šçš„å‡½æ•°å¼•ç”¨
useEffect(() => {
  const init = async () => {
    prefetchPages();
    await fetchUser();
  };
  init();
}, [session, status, fetchUser, prefetchPages]);

// ä¿®å¤å - å†…è”å‡½æ•°è°ƒç”¨ï¼Œç§»é™¤ä¸ç¨³å®šä¾èµ–
useEffect(() => {
  const init = async () => {
    // å†…è”é¢„åŠ è½½é€»è¾‘
    if (typeof window !== 'undefined') {
      const coreModules = [
        { path: '/quotation' },
        { path: '/packing' },
        // ...
      ];
      coreModules.forEach(module => {
        router.prefetch(module.path);
      });
    }
    await fetchUser();
  };
  init();
}, [session, status, router]); // ç§»é™¤ fetchUser å’Œ prefetchPages ä¾èµ–
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ä¿®å¤æ‰€æœ‰å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“çš„ä¾èµ–é¡¹

### éªŒè¯ç»“æœ
- âœ… æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
- âœ… æ¶ˆé™¤äº†é¢‘ç¹çš„ Fast Refresh é‡å»º
- âœ… å‡å°‘äº†ä¸å¿…è¦çš„ API è¯·æ±‚
- âœ… æ€§èƒ½ç›‘æ§ä¸å†å¯¼è‡´æ— é™å¾ªç¯
- âœ… æƒé™ç³»ç»Ÿæ­£å¸¸å·¥ä½œ

### æŠ€æœ¯è¦ç‚¹
1. **ä¾èµ–é¡¹ç¨³å®šæ€§**: é¿å…åœ¨ useMemo å’Œ useEffect ä¸­ä¾èµ–ä¸ç¨³å®šçš„å‡½æ•°å¼•ç”¨
2. **ç›´æ¥æ•°æ®è®¿é—®**: ç›´æ¥ä»ç”¨æˆ·æƒé™æ•°æ®è®¡ç®—ï¼Œè€Œä¸æ˜¯è°ƒç”¨å¯èƒ½å˜åŒ–çš„å‡½æ•°
3. **å†…è”é€»è¾‘**: å°†ä¸ç¨³å®šçš„å‡½æ•°è°ƒç”¨å†…è”åˆ° useEffect ä¸­
4. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“å’Œè®¡ç®—

---

## æœ€æ–°ä¿®å¤ - æƒé™åˆ·æ–°APIä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šä¿®æ”¹æƒé™åï¼Œæ‰‹åŠ¨ç‚¹å‡»"åˆ·æ–°æƒé™"èœå•ä»ç„¶æ— æ³•æ˜¾ç¤ºæœ€æ–°æƒé™ã€‚ç»è¿‡æµ‹è¯•å‘ç°ï¼š
1. æƒé™åˆ·æ–°APIè¿”å›"æœåŠ¡å™¨é”™è¯¯"
2. åç«¯APIç«¯ç‚¹ä¸å¯è®¿é—®ï¼ˆ404é”™è¯¯ï¼‰
3. æƒé™åˆ·æ–°é€»è¾‘è°ƒç”¨é”™è¯¯çš„æ–¹æ³•

### æ ¹æœ¬åŸå› åˆ†æ
1. **APIç«¯ç‚¹é—®é¢˜**: åŸAPIå°è¯•è°ƒç”¨å¤–éƒ¨åç«¯æœåŠ¡ `https://udb.luocompany.net/api/admin/users/${userId}`ï¼Œä½†è¯¥ç«¯ç‚¹è¿”å›404
2. **æƒé™åˆ·æ–°é€»è¾‘é”™è¯¯**: `handleRefreshPermissions` è°ƒç”¨ `fetchUser()` è€Œä¸æ˜¯ `refreshPermissions()`
3. **Sessionè·å–å¤±è´¥**: APIæ— æ³•åœ¨ç›´æ¥è°ƒç”¨æ—¶è·å–ç”¨æˆ·session

### ä¿®å¤æªæ–½

#### 1. ä¿®å¤æƒé™åˆ·æ–°é€»è¾‘
```typescript
// ä¿®å¤å‰
const handleRefreshPermissions = useCallback(async () => {
  usePermissionStore.getState().clearUser();
  await fetchUser(); // ä»sessionè·å–ï¼Œä¸æ˜¯æœ€æ–°æƒé™
}, [fetchUser]);

// ä¿®å¤å
const handleRefreshPermissions = useCallback(async () => {
  const { refreshPermissions } = usePermissionStore.getState();
  await refreshPermissions(); // ä»APIè·å–æœ€æ–°æƒé™
}, []);
```

#### 2. ä¿®å¤æƒé™è·å–API
```typescript
// ä¿®å¤å‰ - è°ƒç”¨å¤–éƒ¨API
const response = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/api/admin/users/${userId}`);

// ä¿®å¤å - ä»sessionè·å–æƒé™ï¼Œå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æƒé™
try {
  const session = await getServerSession(authOptions);
  // å¤„ç†sessionä¸­çš„æƒé™æ•°æ®
} catch (sessionError) {
  // ä½¿ç”¨é»˜è®¤æƒé™
  if (isAdmin) {
    permissions = [
      { id: 'default-quotation', moduleId: 'quotation', canAccess: true },
      // ... å…¶ä»–æƒé™
    ];
  }
}
```

#### 3. å¢å¼ºé”™è¯¯å¤„ç†
```typescript
// æ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
return NextResponse.json({ error: `æœåŠ¡å™¨é”™è¯¯: ${errorMessage}` }, { status: 500 });
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ä¿®å¤æƒé™åˆ·æ–°å¤„ç†å‡½æ•°
- `src/app/api/auth/get-latest-permissions/route.ts`: ä¿®å¤APIé€»è¾‘å’Œé”™è¯¯å¤„ç†

### éªŒè¯ç»“æœ
- âœ… APIæ­£å¸¸è¿”å›æƒé™æ•°æ®
- âœ… æƒé™åˆ·æ–°é€»è¾‘è°ƒç”¨æ­£ç¡®çš„æ–¹æ³•
- âœ… é”™è¯¯å¤„ç†æ›´åŠ è¯¦ç»†
- âœ… é»˜è®¤æƒé™æœºåˆ¶ç¡®ä¿åŠŸèƒ½å¯ç”¨

### æŠ€æœ¯è¦ç‚¹
1. **APIè®¾è®¡**: ä»sessionè·å–æƒé™ï¼Œå¤±è´¥æ—¶æä¾›é»˜è®¤æƒé™
2. **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å¸®åŠ©è°ƒè¯•
3. **æƒé™åˆ·æ–°**: ç¡®ä¿è°ƒç”¨æ­£ç¡®çš„APIæ–¹æ³•
4. **å‘åå…¼å®¹**: é»˜è®¤æƒé™ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨

---

## æœ€æ–°ä¿®å¤ - React Hooks è§„åˆ™ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šäº†æŒç»­çš„ React Hooks é”™è¯¯ï¼š
- "Warning: React has detected a change in the order of Hooks called by DashboardPage"
- "Error: Rendered more hooks than during the previous render"
- "Warning: Cannot update a component while rendering a different component"
- é¢‘ç¹çš„ "Fast Refresh rebuilding" æ¶ˆæ¯

### æ ¹æœ¬åŸå› åˆ†æ
1. **setTimeout åŒ…è£…å™¨é—®é¢˜**: å¤šä¸ª `setTimeout(..., 0)` åŒ…è£…å™¨è¢«é‡æ–°å¼•å…¥åˆ° `setState` è°ƒç”¨ä¸­
2. **Hooks é¡ºåºè¿è§„**: é‡å®šå‘ `useEffect` è¢«æ”¾ç½®åœ¨æ¡ä»¶è¿”å›è¯­å¥ä¹‹å
3. **æ¸²æŸ“é˜¶æ®µçŠ¶æ€æ›´æ–°**: åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è°ƒç”¨ `setState` å¯¼è‡´ç»„ä»¶æ›´æ–°å†²çª

### ä¿®å¤æªæ–½

#### 1. ç§»é™¤æ‰€æœ‰ setTimeout åŒ…è£…å™¨
```typescript
// ä¿®å¤å‰
setTimeout(() => {
  setRecentDocuments(sorted);
}, 0);

// ä¿®å¤å
setRecentDocuments(sorted);
```

#### 2. ä¿®å¤ Hooks é¡ºåº
```typescript
// ä¿®å¤å‰ - useEffect åœ¨æ¡ä»¶è¿”å›å
if (!mounted) return null;
if (status === 'loading') return (...);
useEffect(() => {
  if (!session && !user) {
    router.push('/');
  }
}, [session, user, router]);

// ä¿®å¤å - useEffect åœ¨æ¡ä»¶è¿”å›å‰
useEffect(() => {
  if (!session && !user) {
    router.push('/');
  }
}, [session, user, router]);
if (!mounted) return null;
if (status === 'loading') return (...);
```

#### 3. ä¿®å¤äº‹ä»¶ç›‘å¬å™¨å®šä¹‰
```typescript
// ä¿®å¤å‰ - å‡½æ•°å®šä¹‰åœ¨ setTimeout å†…
setTimeout(() => {
  const handleCustomStorageChange = (e: CustomEvent) => {
    // ...
  };
  window.addEventListener('customStorageChange', handleCustomStorageChange);
}, 0);

// ä¿®å¤å - å‡½æ•°å®šä¹‰åœ¨ useEffect é¡¶å±‚
const handleCustomStorageChange = (e: CustomEvent) => {
  // ...
};
window.addEventListener('customStorageChange', handleCustomStorageChange);
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ç§»é™¤æ‰€æœ‰ setTimeout åŒ…è£…å™¨ï¼Œä¿®å¤ hooks é¡ºåº

### éªŒè¯ç»“æœ
- âœ… æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
- âœ… ç§»é™¤äº†æ‰€æœ‰å¯¼è‡´ hooks é¡ºåºé”™è¯¯çš„ setTimeout åŒ…è£…å™¨
- âœ… é‡å®šå‘ useEffect ç°åœ¨åœ¨æ¡ä»¶è¿”å›ä¹‹å‰å£°æ˜
- âœ… äº‹ä»¶ç›‘å¬å™¨å‡½æ•°å®šä¹‰åœ¨æ­£ç¡®çš„ä½œç”¨åŸŸå†…

### æŠ€æœ¯è¦ç‚¹
1. **React Hooks è§„åˆ™**: æ‰€æœ‰ hooks å¿…é¡»åœ¨ç»„ä»¶é¡¶å±‚æ— æ¡ä»¶è°ƒç”¨
2. **æ¸²æŸ“é˜¶æ®µé™åˆ¶**: é¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è°ƒç”¨ setState
3. **äº‹ä»¶ç›‘å¬å™¨ä½œç”¨åŸŸ**: ç¡®ä¿æ¸…ç†å‡½æ•°èƒ½æ­£ç¡®å¼•ç”¨äº‹ä»¶å¤„ç†å‡½æ•°

---

## æœ€æ–°ä¿®å¤ - ç»„ä»¶å¯¼å…¥é”™è¯¯ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šäº†ç»„ä»¶å¯¼å…¥é”™è¯¯ï¼š
- "Attempted import error: '@/components/Header' does not contain a default export"
- "Element type is invalid: expected a string... but got: undefined"

### ä¿®å¤æªæ–½
å°†é»˜è®¤å¯¼å…¥æ”¹ä¸ºå‘½åå¯¼å…¥ï¼š

```typescript
// ä¿®å¤å‰
import Header from '@/components/Header';
import ProfileModal from '@/components/profile/ProfileModal';

// ä¿®å¤å
import { Header } from '@/components/Header';
import { ProfileModal } from '@/components/profile/ProfileModal';
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ä¿®å¤ Header å’Œ ProfileModal çš„å¯¼å…¥æ–¹å¼

---

## æƒé™åˆ·æ–°é—®é¢˜ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
1. æ‰‹åŠ¨ç‚¹å‡»åˆ·æ–°æƒé™èœå•ï¼Œæ— æ³•æ˜¾ç¤ºæœ€æ–°ç»“æœ
2. ä¸æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œæ–°æƒé™æ— æ³•å‡ºç°
3. æƒé™æ•°æ®æ ¼å¼ä¸ä¸€è‡´

### ä¿®å¤æªæ–½

#### 1. ä¿®æ”¹æƒé™è·å–API
```typescript
// src/app/api/auth/get-latest-permissions/route.ts
// ç›´æ¥ä»åç«¯è·å–æœ€æ–°æƒé™ï¼Œç»•è¿‡ NextAuth ç¼“å­˜
const response = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/api/admin/users/${userId}`, {
  method: 'GET',
  headers: {
    'X-User-ID': userId,
    'X-User-Name': userName,
    'X-User-Admin': isAdmin ? 'true' : 'false'
  }
});
```

#### 2. ä¼˜åŒ–æƒé™å­˜å‚¨æ›´æ–°
```typescript
// src/lib/permissions.ts
// ä½¿ç”¨ cache: 'no-store' ç¡®ä¿è·å–æœ€æ–°æ•°æ®
const response = await fetch('/api/auth/get-latest-permissions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-User-ID': user.id,
    'X-User-Name': user.username,
    'X-User-Admin': user.isAdmin ? 'true' : 'false'
  },
  cache: 'no-store'
});
```

#### 3. ç»Ÿä¸€æƒé™æ•°æ®æ ¼å¼
```typescript
// ç¡®ä¿æ‰€æœ‰æƒé™æ•°æ®éƒ½æ˜¯ Permission[] æ ¼å¼
interface Permission {
  id: string;
  moduleId: string;
  canAccess: boolean;
}
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/api/auth/get-latest-permissions/route.ts`: ç›´æ¥ä»åç«¯è·å–æƒé™
- `src/lib/permissions.ts`: ä¼˜åŒ–æƒé™æ›´æ–°é€»è¾‘
- `src/lib/auth.ts`: ç»Ÿä¸€æƒé™æ•°æ®æ ¼å¼

---

## å¼ºåˆ¶é‡æ–°ç™»å½•é—®é¢˜ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ä¿®æ”¹æƒé™åè¿”å› dashboard æ—¶ï¼Œä¼šå¼ºåˆ¶è·³è½¬åˆ°ç™»å½•é¡µé¢

### ä¿®å¤æªæ–½

#### 1. ç§»é™¤å¼ºåˆ¶é‡æ–°ç™»å½•é€»è¾‘
```typescript
// src/app/admin/users/[id]/page.tsx
// ç§»é™¤ signOut è°ƒç”¨ï¼Œæ”¹ä¸ºæ˜¾ç¤ºæç¤ºä¿¡æ¯
setSuccessMessage('æƒé™å·²æ›´æ–°ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨åˆ·æ–°æƒé™');
```

#### 2. ä¼˜åŒ– dashboard é‡å®šå‘é€»è¾‘
```typescript
// src/app/dashboard/page.tsx
// åªåœ¨çœŸæ­£æœªç™»å½•æ—¶æ‰é‡å®šå‘
useEffect(() => {
  if (!session && !user) {
    router.push('/');
  }
}, [session, user, router]);
```

#### 3. ä¿®æ”¹ NextAuth session å›è°ƒ
```typescript
// src/lib/auth.ts
// ç›´æ¥ä½¿ç”¨ token ä¸­çš„æƒé™ï¼Œä¸é‡æ–°è·å–
session: (session, token) => {
  return {
    ...session,
    user: {
      ...session.user,
      permissions: token.permissions || []
    }
  };
}
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/admin/users/[id]/page.tsx`: ç§»é™¤å¼ºåˆ¶é‡æ–°ç™»å½•
- `src/app/dashboard/page.tsx`: ä¼˜åŒ–é‡å®šå‘é€»è¾‘
- `src/lib/auth.ts`: ä¼˜åŒ– session å›è°ƒ

---

## åˆå§‹é—®é¢˜ - TypeScript ç±»å‹é”™è¯¯ (2024-12-19)

### é—®é¢˜æè¿°
`å˜é‡"permissions"éšå¼å…·æœ‰"any[]"ç±»å‹ã€‚`

### ä¿®å¤æªæ–½
åœ¨ `src/app/api/auth/get-latest-permissions/route.ts` ä¸­å®šä¹‰æ¥å£å¹¶æ˜ç¡®ç±»å‹ï¼š

```typescript
interface Permission {
  id: string;
  moduleId: string;
  canAccess: boolean;
}

// æ˜ç¡®æŒ‡å®šç±»å‹
const permissions: Permission[] = data.permissions || [];
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/api/auth/get-latest-permissions/route.ts`: æ·»åŠ ç±»å‹å®šä¹‰

---

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¿®å¤ï¼Œè§£å†³äº†ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

1. âœ… **TypeScript ç±»å‹é”™è¯¯**: å®šä¹‰äº†æ˜ç¡®çš„ Permission æ¥å£
2. âœ… **æƒé™åˆ·æ–°é—®é¢˜**: å®ç°äº†ç›´æ¥ä»åç«¯è·å–æœ€æ–°æƒé™çš„æœºåˆ¶
3. âœ… **å¼ºåˆ¶é‡æ–°ç™»å½•é—®é¢˜**: ç§»é™¤äº†ä¸å¿…è¦çš„é‡æ–°ç™»å½•é€»è¾‘
4. âœ… **React Hooks é”™è¯¯**: ä¿®å¤äº† hooks é¡ºåºå’Œæ¸²æŸ“é˜¶æ®µçŠ¶æ€æ›´æ–°é—®é¢˜
5. âœ… **ç»„ä»¶å¯¼å…¥é”™è¯¯**: ä¿®å¤äº†å‘½åå¯¼å…¥é—®é¢˜

æ‰€æœ‰ä¿®å¤éƒ½éµå¾ªäº† React æœ€ä½³å®è·µï¼Œç¡®ä¿äº†ä»£ç çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ 