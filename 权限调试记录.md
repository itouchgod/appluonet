# æƒé™è°ƒè¯•è®°å½•

## å½“å‰çŠ¶æ€ - é—®é¢˜è§£å†³è¿›å±• (2024-12-19)

### âœ… **å·²æˆåŠŸè§£å†³çš„é—®é¢˜**
1. **æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯** - é€šè¿‡ç¦ç”¨æ€§èƒ½ç›‘æ§å½»åº•è§£å†³
2. **React Hooks é”™è¯¯** - ä¿®å¤äº†æ‰€æœ‰ hooks é¡ºåºå’Œä¾èµ–é¡¹é—®é¢˜
3. **æƒé™åˆ·æ–°API** - æ­£å¸¸å·¥ä½œï¼Œè¿”å›æ­£ç¡®çš„æƒé™æ•°æ®
4. **æœåŠ¡å™¨ç¨³å®šæ€§** - åº”ç”¨ç¨‹åºç¨³å®šè¿è¡Œï¼Œæ— å´©æºƒ

### ğŸ” **å½“å‰å‘ç°çš„é—®é¢˜**

#### 1. æƒé™æ˜ å°„é€»è¾‘é—®é¢˜
**ç°è±¡**: ç”¨æˆ·æœ‰14ä¸ªæƒé™ï¼Œä½† `accessibleDocumentTypes: Array(0)`
**å¯èƒ½åŸå› **: 
- æƒé™æ•°æ®æ ¼å¼ä¸åŒ¹é…
- æƒé™æ£€æŸ¥é€»è¾‘æœ‰è¯¯
- æƒé™IDä¸æ¨¡å—IDä¸åŒ¹é…

**è°ƒè¯•ä¿¡æ¯**:
```javascript
æƒé™æ˜ å°„æ›´æ–°: {
  user: 'luojun',
  userPermissions: Array(14),
  permissions: {...},
  documentTypePermissions: {...},
  accessibleDocumentTypes: Array(0), // é—®é¢˜ï¼šåº”è¯¥ä¸ä¸ºç©º
  permissionChecks: {...}, // æ–°å¢è°ƒè¯•ä¿¡æ¯
  samplePermissions: [...] // æ–°å¢è°ƒè¯•ä¿¡æ¯
}
```

#### 2. é‡å¤çš„æƒé™è·å–
**ç°è±¡**: æƒé™è·å–å’Œæ˜ å°„æ›´æ–°è¢«é‡å¤æ‰§è¡Œ
**å¯èƒ½åŸå› **:
- ç»„ä»¶é‡æ–°æ¸²æŸ“å¯¼è‡´é‡å¤è°ƒç”¨
- ä¾èµ–é¡¹ä¸ç¨³å®šå¯¼è‡´ useMemo é‡å¤è®¡ç®—

#### 3. æ€§èƒ½ç›‘æ§æ¥æº
**å‘ç°**: æ€§èƒ½ç›‘æ§æ—¥å¿—æ¥è‡ªå…¶ä»–é¡µé¢ï¼ˆ`page.tsx`, `tools/page.tsx`ï¼‰
**å½±å“**: ä¸å½±å“ dashboard é¡µé¢çš„ç¨³å®šæ€§

### ğŸ¯ **ä¸‹ä¸€æ­¥ä¿®å¤è®¡åˆ’**

#### 1. ä¿®å¤æƒé™æ˜ å°„é€»è¾‘
- æ£€æŸ¥ç”¨æˆ·æƒé™æ•°æ®æ ¼å¼
- éªŒè¯æƒé™IDä¸æ¨¡å—IDçš„åŒ¹é…
- æ·»åŠ æ›´è¯¦ç»†çš„æƒé™æ£€æŸ¥è°ƒè¯•ä¿¡æ¯

#### 2. ä¼˜åŒ–æƒé™è·å–é€»è¾‘
- å‡å°‘ä¸å¿…è¦çš„æƒé™è·å–
- ä¼˜åŒ– useMemo ä¾èµ–é¡¹
- ç¡®ä¿æƒé™æ•°æ®çš„ä¸€è‡´æ€§

#### 3. ç»Ÿä¸€æ€§èƒ½ç›‘æ§
- è€ƒè™‘åœ¨å…¶ä»–é¡µé¢ä¹Ÿç¦ç”¨æ€§èƒ½ç›‘æ§
- æˆ–è€…é‡æ–°è®¾è®¡æ€§èƒ½ç›‘æ§ç³»ç»Ÿ

### ğŸ“Š **æ¦‚å¿µæ¾„æ¸… (é‡è¦å‘ç°)**

#### æƒé™ç³»ç»Ÿæ¦‚å¿µ
- **14ä¸ªæ¨¡å—** = ç³»ç»Ÿä¸­å®šä¹‰çš„æ‰€æœ‰å¯ç”¨æ¨¡å—ï¼ˆquotation, packing, invoice, purchaseç­‰ï¼‰
- **æƒé™** = ç”¨æˆ·è¢«åˆ†é…çš„å…·ä½“æ¨¡å—è®¿é—®æƒé™
- **ç”¨æˆ·æƒé™** = ç”¨æˆ·å®é™…è¢«æˆæƒçš„æ¨¡å—åˆ—è¡¨

#### æƒé™æ•°æ®æ ¼å¼
ç”¨æˆ·æƒé™æ•°æ®åº”è¯¥æ˜¯è¿™æ ·çš„æ ¼å¼ï¼š
```javascript
permissions: [
  { id: '1', moduleId: 'quotation', canAccess: true },
  { id: '2', moduleId: 'packing', canAccess: true },
  { id: '3', moduleId: 'invoice', canAccess: false },
  // ... å…¶ä»–æ¨¡å—æƒé™
]
```

#### æƒé™æ˜ å°„é€»è¾‘
ä»£ç ä¸­æ£€æŸ¥çš„æ¨¡å—IDï¼š
- `quotation` - æŠ¥ä»·å•
- `packing` - è£…ç®±å•  
- `invoice` - å‘ç¥¨
- `purchase` - é‡‡è´­å•

#### å½“å‰è°ƒè¯•é‡ç‚¹
1. **éªŒè¯æƒé™æ•°æ®æ ¼å¼** - ç¡®è®¤ç”¨æˆ·æƒé™æ˜¯å¦åŒ…å«æ­£ç¡®çš„ `moduleId` å’Œ `canAccess` å­—æ®µ
2. **æ£€æŸ¥æ¨¡å—IDåŒ¹é…** - ç¡®è®¤æƒé™ä¸­çš„ `moduleId` ä¸ä»£ç ä¸­æ£€æŸ¥çš„æ¨¡å—IDä¸€è‡´
3. **æƒé™æ£€æŸ¥é€»è¾‘** - éªŒè¯ `hasPermissionDirect` å‡½æ•°æ˜¯å¦æ­£ç¡®æ‰¾åˆ°æƒé™

### ğŸ” **è¯¦ç»†è°ƒè¯•ä¿¡æ¯**

å·²æ·»åŠ çš„è°ƒè¯•ä¿¡æ¯åŒ…æ‹¬ï¼š
- æ¯ä¸ªæ¨¡å—çš„æƒé™æ£€æŸ¥è¯¦æƒ…
- ç”¨æˆ·æ‰€æœ‰æƒé™çš„åˆ—è¡¨
- æƒé™æ˜ å°„çš„å®Œæ•´è¿‡ç¨‹
- æƒé™æ•°æ®æ ¼å¼åˆ†æ

è¿™äº›ä¿¡æ¯å°†å¸®åŠ©æˆ‘ä»¬ç¡®å®šï¼š
1. ç”¨æˆ·æƒé™æ•°æ®æ˜¯å¦åŒ…å«æ­£ç¡®çš„æ¨¡å—ID
2. æƒé™æ£€æŸ¥é€»è¾‘æ˜¯å¦æ­£ç¡®
3. ä¸ºä»€ä¹ˆ `accessibleDocumentTypes` ä¸ºç©º

### ğŸ¯ **æƒé™æ•°æ®æ ¼å¼é—®é¢˜ä¿®å¤ (2024-12-19)**

#### é—®é¢˜æ ¹æºå‘ç°
é€šè¿‡APIæµ‹è¯•å‘ç°ï¼š
- **APIè¿”å›çš„æƒé™æ•°æ®æ ¼å¼æ­£ç¡®**: `{"moduleId":"quotation","canAccess":true}`
- **Sessionä¸­çš„æƒé™æ•°æ®æ ¼å¼æœ‰é—®é¢˜**: å¯¼è‡´æƒé™æ£€æŸ¥å¤±è´¥
- **æƒé™æ£€æŸ¥å…¨éƒ¨å¤±è´¥**: æ‰€æœ‰æ¨¡å—çš„ `canAccess: false`

#### å…³é”®å‘ç°
1. **APIæƒé™æ•°æ®**: 6ä¸ªæƒé™ï¼Œæ ¼å¼æ­£ç¡®ï¼Œæ‰€æœ‰ `canAccess: true`
2. **Sessionæƒé™æ•°æ®**: 14ä¸ªæƒé™ï¼Œæ ¼å¼å¯èƒ½ä¸æ­£ç¡®
3. **æƒé™è·å–æ–¹å¼**: `fetchUser()` ä»sessionè·å–ï¼Œ`refreshPermissions()` ä»APIè·å–

#### ä¿®å¤æ–¹æ¡ˆ
**å°†æƒé™è·å–æ–¹å¼ä» `fetchUser()` æ”¹ä¸º `refreshPermissions()`**:
```javascript
// ä¿®æ”¹å‰ - ä»sessionè·å–æƒé™ï¼ˆæ ¼å¼å¯èƒ½æœ‰é—®é¢˜ï¼‰
await fetchUser();

// ä¿®æ”¹å - ä»APIè·å–æœ€æ–°æƒé™ï¼ˆæ ¼å¼æ­£ç¡®ï¼‰
await usePermissionStore.getState().refreshPermissions();
```

#### ä¿®å¤æ•ˆæœé¢„æœŸ
1. **æƒé™æ•°æ®æ ¼å¼æ­£ç¡®** - ä½¿ç”¨APIè¿”å›çš„æ ‡å‡†æ ¼å¼
2. **æƒé™æ£€æŸ¥æˆåŠŸ** - æ‰€æœ‰æ¨¡å—çš„ `canAccess` åº”è¯¥ä¸º `true`
3. **å¯è®¿é—®æ–‡æ¡£ç±»å‹** - `accessibleDocumentTypes` åº”è¯¥åŒ…å«æ‰€æœ‰æ¨¡å—
4. **æƒé™æ˜ å°„æ­£å¸¸** - ç”¨æˆ·åº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰æœ‰æƒé™çš„æ¨¡å—

#### è°ƒè¯•ä¿¡æ¯å¢å¼º
æ·»åŠ äº†è¯¦ç»†çš„æƒé™æ•°æ®è°ƒè¯•ä¿¡æ¯ï¼š
- Sessionæƒé™æ•°æ®æ ¼å¼åˆ†æ
- APIæƒé™æ•°æ®æ ¼å¼åˆ†æ
- æƒé™æ£€æŸ¥è¿‡ç¨‹è¯¦ç»†æ—¥å¿—
- æƒé™æ˜ å°„å®Œæ•´è¿‡ç¨‹

è¿™å°†å¸®åŠ©æˆ‘ä»¬ï¼š
1. ç¡®è®¤æƒé™æ•°æ®æ ¼å¼çš„ä¸€è‡´æ€§
2. éªŒè¯æƒé™æ£€æŸ¥é€»è¾‘çš„æ­£ç¡®æ€§
3. ç¡®ä¿æƒé™æ˜ å°„çš„å‡†ç¡®æ€§

### ğŸš¨ **"æœªç™»å½•"é”™è¯¯ä¿®å¤ (2024-12-19)**

#### é—®é¢˜å‘ç°
ä¿®æ”¹æƒé™è·å–æ–¹å¼åå‡ºç°æ–°é—®é¢˜ï¼š
```
æƒé™åˆ·æ–°å¤±è´¥: Error: æœªç™»å½•
at Object.refreshPermissions (permissions.ts:184:15)
```

#### é—®é¢˜æ ¹æº
`refreshPermissions` å‡½æ•°éœ€è¦å…ˆæœ‰ç”¨æˆ·ä¿¡æ¯æ‰èƒ½å·¥ä½œï¼Œä½†åœ¨ç™»å½•è¿‡ç¨‹ä¸­ï¼š
1. **ç”¨æˆ·ä¿¡æ¯è¿˜æ²¡æœ‰è®¾ç½®åˆ°storeä¸­** - `get().user` ä¸º `null`
2. **ç™»å½•æ—¶åºé—®é¢˜** - sessionå·²å­˜åœ¨ä½†storeä¸­è¿˜æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯
3. **æƒé™è·å–æ—¶æœºé”™è¯¯** - åœ¨ç”¨æˆ·ä¿¡æ¯è®¾ç½®ä¹‹å‰å°±å°è¯•è·å–æƒé™

#### ä¿®å¤æ–¹æ¡ˆ
**ä¿®æ”¹ `refreshPermissions` å‡½æ•°ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯çš„æƒ…å†µ**:

```javascript
refreshPermissions: async () => {
  try {
    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    let currentUser = get().user;
    
    // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•ä»sessionè·å–
    if (!currentUser) {
      const session = await getSession();
      if (!session?.user) {
        throw new Error('æœªç™»å½•');
      }
      
      // ä»sessionåˆ›å»ºç”¨æˆ·ä¿¡æ¯
      currentUser = {
        id: session.user.id || session.user.username || '',
        username: session.user.username || session.user.name || '',
        email: session.user.email || null,
        status: true,
        isAdmin: session.user.isAdmin || false,
        permissions: []
      };
      
      // å…ˆè®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°store
      set(state => ({ 
        ...state,
        user: currentUser,
        isLoading: false,
        error: null
      }));
    }
    
    // ç»§ç»­åŸæœ‰çš„æƒé™è·å–é€»è¾‘...
  }
}
```

#### ä¿®å¤æ•ˆæœ
1. **è§£å†³æ—¶åºé—®é¢˜** - ç¡®ä¿åœ¨è·å–æƒé™å‰æœ‰ç”¨æˆ·ä¿¡æ¯
2. **å…¼å®¹ç™»å½•è¿‡ç¨‹** - æ”¯æŒä»sessionè·å–ç”¨æˆ·ä¿¡æ¯
3. **ä¿æŒåŠŸèƒ½å®Œæ•´** - ä¸å½±å“åŸæœ‰çš„æƒé™è·å–é€»è¾‘
4. **é”™è¯¯å¤„ç†å®Œå–„** - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

#### å…³é”®æ”¹è¿›
- **è‡ªåŠ¨ç”¨æˆ·ä¿¡æ¯è·å–** - å½“storeä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œè‡ªåŠ¨ä»sessionè·å–
- **ç”¨æˆ·ä¿¡æ¯é¢„è®¾ç½®** - åœ¨è·å–æƒé™å‰å…ˆè®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°store
- **é”™è¯¯å¤„ç†ä¼˜åŒ–** - æä¾›æ›´å‡†ç¡®çš„é”™è¯¯ä¿¡æ¯
- **æ—¶åºé—®é¢˜è§£å†³** - ç¡®ä¿ç™»å½•å’Œæƒé™è·å–çš„æ­£ç¡®é¡ºåº

### ğŸ”¥ **æ€§èƒ½ç›‘æ§æ— é™é‡æ–°æ¸²æŸ“ä¿®å¤ (2024-12-19)**

#### é—®é¢˜å‘ç°
ä¿®å¤æƒé™è·å–åå‡ºç°æ–°çš„æ— é™é‡æ–°æ¸²æŸ“é—®é¢˜ï¼š
```
performance.ts:130 ğŸš€ ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼Œè·³è¿‡å­—ä½“é¢„åŠ è½½
performance.ts:36 â±ï¸ page_load: 0.70ms
page.tsx:33 ğŸ“Š é¡µé¢åŠ è½½æ€§èƒ½: {...}
```
å¤§é‡é‡å¤çš„æ€§èƒ½ç›‘æ§æ—¥å¿—ï¼Œè¡¨æ˜é¡µé¢åœ¨ä¸æ–­é‡æ–°æ¸²æŸ“ã€‚

#### é—®é¢˜æ ¹æº
æ€§èƒ½ç›‘æ§ç³»ç»Ÿåœ¨å¤šä¸ªé¡µé¢ä¸­åŒæ—¶è¿è¡Œï¼š
1. **`page.tsx`** - ç™»å½•é¡µé¢æ€§èƒ½ç›‘æ§
2. **`tools/page.tsx`** - å·¥å…·é¡µé¢æ€§èƒ½ç›‘æ§
3. **`dashboard/page.tsx`** - ä»ªè¡¨æ¿é¡µé¢æ€§èƒ½ç›‘æ§ï¼ˆå·²ç¦ç”¨ï¼‰

è¿™äº›æ€§èƒ½ç›‘æ§ç³»ç»Ÿç›¸äº’å½±å“ï¼Œå¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯ã€‚

#### ä¿®å¤æ–¹æ¡ˆ
**å®Œå…¨ç¦ç”¨æ‰€æœ‰é¡µé¢çš„æ€§èƒ½ç›‘æ§ç³»ç»Ÿ**:

```javascript
// page.tsx - ç¦ç”¨ç™»å½•é¡µé¢æ€§èƒ½ç›‘æ§
// performanceMonitor.startTimer('page_load');
// performanceMonitor.startTimer('login_request');

// tools/page.tsx - ç¦ç”¨å·¥å…·é¡µé¢æ€§èƒ½ç›‘æ§  
// performanceMonitor.startTimer('tools_page_load');
// performanceMonitor.monitorResourceLoading();

// dashboard/page.tsx - å·²ç¦ç”¨
// performanceMonitor.startTimer('dashboard_page_load');
```

#### ä¿®å¤æ•ˆæœ
1. **åœæ­¢æ— é™é‡æ–°æ¸²æŸ“** - æ¶ˆé™¤æ€§èƒ½ç›‘æ§å¯¼è‡´çš„å¾ªç¯
2. **æé«˜åº”ç”¨ç¨³å®šæ€§** - é¿å…é¢‘ç¹çš„é¡µé¢é‡æ–°åŠ è½½
3. **æ”¹å–„ç”¨æˆ·ä½“éªŒ** - å‡å°‘å¡é¡¿å’Œå»¶è¿Ÿ
4. **ä¿æŒåŠŸèƒ½å®Œæ•´** - ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

#### å…³é”®æ”¹è¿›
- **å…¨é¢ç¦ç”¨æ€§èƒ½ç›‘æ§** - åœ¨æ‰€æœ‰é¡µé¢ä¸­ç¦ç”¨æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
- **ä¿æŒæ ¸å¿ƒåŠŸèƒ½** - æƒé™ç³»ç»Ÿã€ç”¨æˆ·è®¤è¯ç­‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- **ä¼˜åŒ–å¼€å‘ä½“éªŒ** - å‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“å’Œæ—¥å¿—è¾“å‡º
- **æé«˜åº”ç”¨æ€§èƒ½** - æ¶ˆé™¤æ€§èƒ½ç›‘æ§æœ¬èº«å¸¦æ¥çš„æ€§èƒ½å¼€é”€

#### åç»­è®¡åˆ’
æ€§èƒ½ç›‘æ§ç³»ç»Ÿå°†åœ¨åº”ç”¨ç¨³å®šåé‡æ–°è®¾è®¡ï¼š
1. **é‡æ–°è®¾è®¡æ€§èƒ½ç›‘æ§** - é¿å…å½±å“åº”ç”¨ç¨³å®šæ€§
2. **é€‰æ‹©æ€§å¯ç”¨** - åªåœ¨éœ€è¦æ—¶å¯ç”¨æ€§èƒ½ç›‘æ§
3. **ä¼˜åŒ–ç›‘æ§é€»è¾‘** - å‡å°‘å¯¹åº”ç”¨æ€§èƒ½çš„å½±å“

### ğŸš¨ **handleLoad å‡½æ•°é”™è¯¯ä¿®å¤ (2024-12-19)**

#### é—®é¢˜å‘ç°
ç¦ç”¨æ€§èƒ½ç›‘æ§åå‡ºç°æ–°çš„é”™è¯¯ï¼š
```
Uncaught ReferenceError: handleLoad is not defined
at eval (page.tsx:38:7)
```

#### é—®é¢˜æ ¹æº
åœ¨ç¦ç”¨æ€§èƒ½ç›‘æ§æ—¶ï¼š
1. **æ³¨é‡Šäº† `handleLoad` å‡½æ•°å®šä¹‰** - ä½†å¿˜è®°æ³¨é‡Šå‡½æ•°è°ƒç”¨
2. **äº‹ä»¶ç›‘å¬å™¨ä»ç„¶åœ¨å¼•ç”¨æœªå®šä¹‰çš„å‡½æ•°** - å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
3. **æ— é™é”™è¯¯å¾ªç¯** - é”™è¯¯å¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œå†æ¬¡è§¦å‘é”™è¯¯

#### ä¿®å¤æ–¹æ¡ˆ
**å®Œå…¨æ³¨é‡Šæ‰æ‰€æœ‰ä¸æ€§èƒ½ç›‘æ§ç›¸å…³çš„ä»£ç **:

```javascript
// ä¿®å¤å‰ - å‡½æ•°è¢«æ³¨é‡Šä½†è°ƒç”¨ä»åœ¨
// const handleLoad = () => { ... };
if (document.readyState === 'complete') {
  handleLoad(); // âŒ é”™è¯¯ï¼šå‡½æ•°æœªå®šä¹‰
}

// ä¿®å¤å - å®Œå…¨ç¦ç”¨æ€§èƒ½ç›‘æ§
// const handleLoad = () => { ... };
// if (document.readyState === 'complete') {
//   handleLoad();
// } else {
//   window.addEventListener('load', handleLoad);
//   return () => window.removeEventListener('load', handleLoad);
// }
```

#### ä¿®å¤æ•ˆæœ
1. **æ¶ˆé™¤è¿è¡Œæ—¶é”™è¯¯** - ä¸å†æœ‰ `handleLoad is not defined` é”™è¯¯
2. **åœæ­¢æ— é™é”™è¯¯å¾ªç¯** - é¿å…ç»„ä»¶ä¸æ–­é‡æ–°æ¸²æŸ“
3. **åº”ç”¨ç¨³å®šè¿è¡Œ** - é¡µé¢å¯ä»¥æ­£å¸¸åŠ è½½å’Œä½¿ç”¨
4. **ä¿æŒåŠŸèƒ½å®Œæ•´** - ä¸å½±å“æ ¸å¿ƒç™»å½•å’Œæƒé™åŠŸèƒ½

#### å…³é”®æ”¹è¿›
- **å®Œæ•´çš„ä»£ç æ³¨é‡Š** - ç¡®ä¿æ‰€æœ‰ç›¸å…³ä»£ç éƒ½è¢«æ­£ç¡®æ³¨é‡Š
- **é”™è¯¯å¤„ç†å®Œå–„** - é¿å…éƒ¨åˆ†æ³¨é‡Šå¯¼è‡´çš„è¿è¡Œæ—¶é”™è¯¯
- **ä»£ç ä¸€è‡´æ€§** - ç¡®ä¿æ³¨é‡Šå’Œå®é™…ä»£ç çš„ä¸€è‡´æ€§
- **ç¨³å®šæ€§æå‡** - æ¶ˆé™¤æ‰€æœ‰ä¸æ€§èƒ½ç›‘æ§ç›¸å…³çš„é”™è¯¯

#### ç»éªŒæ€»ç»“
åœ¨ç¦ç”¨åŠŸèƒ½æ—¶éœ€è¦æ³¨æ„ï¼š
1. **å®Œæ•´æ³¨é‡Š** - ç¡®ä¿æ‰€æœ‰ç›¸å…³ä»£ç éƒ½è¢«æ³¨é‡Š
2. **ä¾èµ–å…³ç³»** - æ£€æŸ¥å‡½æ•°è°ƒç”¨å’Œäº‹ä»¶ç›‘å¬å™¨
3. **æµ‹è¯•éªŒè¯** - ç¡®ä¿ä¿®æ”¹ååº”ç”¨èƒ½æ­£å¸¸è¿è¡Œ
4. **é”™è¯¯å¤„ç†** - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### ğŸ“ˆ **ä¿®å¤æ•ˆæœå¯¹æ¯”**

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æ— é™é‡æ–°æ¸²æŸ“ | âŒ é¢‘ç¹å‘ç”Ÿ | âœ… å·²è§£å†³ |
| React Hooks é”™è¯¯ | âŒ å¤§é‡é”™è¯¯ | âœ… å·²ä¿®å¤ |
| æƒé™åˆ·æ–°API | âŒ è¿”å›é”™è¯¯ | âœ… æ­£å¸¸å·¥ä½œ |
| æœåŠ¡å™¨ç¨³å®šæ€§ | âŒ é¢‘ç¹å´©æºƒ | âœ… ç¨³å®šè¿è¡Œ |
| æƒé™æ˜ å°„ | âŒ æœªæµ‹è¯• | ğŸ” éœ€è¦ä¿®å¤ |

### ğŸ‰ **ä¸»è¦æˆå°±**
1. **åº”ç”¨ç¨‹åºç¨³å®šæ€§å¤§å¹…æå‡** - ä¸å†æœ‰æ— é™é‡æ–°æ¸²æŸ“
2. **æƒé™ç³»ç»ŸåŸºç¡€åŠŸèƒ½æ­£å¸¸** - æƒé™è·å–å’Œåˆ·æ–°APIå·¥ä½œæ­£å¸¸
3. **å¼€å‘ä½“éªŒæ”¹å–„** - Fast Refresh æ­£å¸¸å·¥ä½œï¼Œæ— å¡é¡¿
4. **æ€§èƒ½æ˜¾è‘—æå‡** - å¤§å¹…å‡å°‘äº†ä¸å¿…è¦çš„APIè¯·æ±‚å’Œé‡æ–°æ¸²æŸ“

---

## æœ€æ–°ä¿®å¤ - æ€§èƒ½ç›‘æ§ç¦ç”¨ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
å³ä½¿ä¿®å¤äº† useMemo ä¾èµ–é¡¹ï¼Œç”¨æˆ·ä»ç„¶æŠ¥å‘Šï¼š
- é¢‘ç¹çš„ `page_load` è®¡æ—¶å™¨å¯åŠ¨
- å¤§é‡çš„ `/api/auth/session` è¯·æ±‚
- åº”ç”¨ç¨‹åºä»ç„¶é™·å…¥æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯

### æ ¹æœ¬åŸå› åˆ†æ
ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°æ€§èƒ½ç›‘æ§ç³»ç»Ÿæ˜¯å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“çš„ä¸»è¦åŸå› ï¼š
1. **æ€§èƒ½ç›‘æ§ useEffect**: å³ä½¿ç§»é™¤äº† `user` ä¾èµ–ï¼Œæ¡ä»¶æ£€æŸ¥ä»ç„¶åŒ…å« `user`
2. **æ€§èƒ½ç›‘æ§å¯åŠ¨**: åˆå§‹çš„æ€§èƒ½ç›‘æ§å¯åŠ¨ä¹Ÿå¯èƒ½å¯¼è‡´é—®é¢˜
3. **è®¡æ—¶å™¨å†²çª**: `performanceMonitor.startTimer` å’Œ `endTimer` çš„è°ƒç”¨æ—¶æœºä¸å½“

### ä¿®å¤æªæ–½

#### 1. å®Œå…¨ç¦ç”¨æ€§èƒ½ç›‘æ§
```typescript
// ä¿®å¤å‰ - æ€§èƒ½ç›‘æ§å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“
useEffect(() => {
  if (mounted && !refreshing) {
    performanceMonitor.endTimer('dashboard_page_load');
    // ...
  }
}, [mounted, refreshing]);

// ä¿®å¤å - å®Œå…¨ç¦ç”¨æ€§èƒ½ç›‘æ§
// useEffect(() => {
//   if (mounted && !refreshing) {
//     performanceMonitor.endTimer('dashboard_page_load');
//     // ...
//   }
// }, [mounted, refreshing]);
```

#### 2. ç¦ç”¨æ€§èƒ½ç›‘æ§å¯åŠ¨
```typescript
// ä¿®å¤å‰ - æ€§èƒ½ç›‘æ§å¯åŠ¨å¯èƒ½å¯¼è‡´é—®é¢˜
useEffect(() => {
  if (typeof window !== 'undefined') {
    performanceMonitor.startTimer('dashboard_page_load');
    // ...
  }
}, []);

// ä¿®å¤å - å®Œå…¨ç¦ç”¨æ€§èƒ½ç›‘æ§å¯åŠ¨
// useEffect(() => {
//   if (typeof window !== 'undefined') {
//     performanceMonitor.startTimer('dashboard_page_load');
//     // ...
//   }
// }, []);
```

#### 3. ç§»é™¤ refreshKey ä¾èµ–
```typescript
// ä¿®å¤å‰ - refreshKey å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯
}, [permissionMap.documentTypePermissions, refreshKey]);

// ä¿®å¤å - ç§»é™¤ refreshKey ä¾èµ–
}, [permissionMap.documentTypePermissions]);
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ç¦ç”¨æ€§èƒ½ç›‘æ§ï¼Œç§»é™¤ refreshKey ä¾èµ–

### éªŒè¯ç»“æœ
- âœ… æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
- âœ… æ¶ˆé™¤äº†é¢‘ç¹çš„ `page_load` è®¡æ—¶å™¨å¯åŠ¨
- âœ… å‡å°‘äº† `/api/auth/session` è¯·æ±‚
- âœ… åº”ç”¨ç¨‹åºä¸å†é™·å…¥æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯
- âœ… æƒé™ç³»ç»Ÿæ­£å¸¸å·¥ä½œ

### æŠ€æœ¯è¦ç‚¹
1. **æ€§èƒ½ç›‘æ§é—®é¢˜**: æ€§èƒ½ç›‘æ§ç³»ç»Ÿå¯èƒ½æ˜¯å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“çš„ä¸»è¦åŸå› 
2. **ä¾èµ–é¡¹ç¨³å®šæ€§**: å³ä½¿ä¿®å¤äº†ä¾èµ–é¡¹ï¼Œæ€§èƒ½ç›‘æ§çš„è°ƒç”¨æ—¶æœºä»å¯èƒ½å¯¼è‡´é—®é¢˜
3. **ä¸´æ—¶ç¦ç”¨**: åœ¨å¼€å‘é˜¶æ®µæš‚æ—¶ç¦ç”¨æ€§èƒ½ç›‘æ§ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ç¨³å®š
4. **æ¸è¿›å¼ä¿®å¤**: å…ˆç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ç¨³å®šï¼Œå†é€æ­¥æ¢å¤æ€§èƒ½ç›‘æ§

### åç»­è®¡åˆ’
1. **é‡æ–°è®¾è®¡æ€§èƒ½ç›‘æ§**: ä½¿ç”¨æ›´ç¨³å®šçš„æ–¹å¼å®ç°æ€§èƒ½ç›‘æ§
2. **ä¾èµ–é¡¹ä¼˜åŒ–**: è¿›ä¸€æ­¥ä¼˜åŒ–æ‰€æœ‰ useMemo å’Œ useEffect çš„ä¾èµ–é¡¹
3. **æ€§èƒ½ç›‘æ§æ¢å¤**: åœ¨ç¡®ä¿ç¨³å®šçš„åŸºç¡€ä¸Šï¼Œé‡æ–°å¯ç”¨æ€§èƒ½ç›‘æ§

---

## æœ€æ–°ä¿®å¤ - æ— é™é‡æ–°æ¸²æŸ“é—®é¢˜ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šäº†ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼š
- é¢‘ç¹çš„ `[Fast Refresh] rebuilding` æ¶ˆæ¯
- å¤§é‡çš„ `page_load` è®¡æ—¶å™¨é‡å¤å¯åŠ¨
- é¢‘ç¹çš„ `/api/auth/session` è¯·æ±‚
- åº”ç”¨ç¨‹åºé™·å…¥æ— é™é‡æ–°æ¸²æŸ“å¾ªç¯

### æ ¹æœ¬åŸå› åˆ†æ
1. **useMemo ä¾èµ–ä¸ç¨³å®š**: `permissionMap` ä¾èµ– `hasPermission` å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°å¼•ç”¨
2. **æ€§èƒ½ç›‘æ§ useEffect**: ä¾èµ– `user` å¯¹è±¡ï¼Œå¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“
3. **åˆå§‹åŒ– useEffect**: ä¾èµ– `fetchUser` å’Œ `prefetchPages` å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¼•ç”¨ä¸ç¨³å®š

### ä¿®å¤æªæ–½

#### 1. ä¿®å¤æƒé™æ˜ å°„ useMemo
```typescript
// ä¿®å¤å‰ - ä¾èµ– hasPermission å‡½æ•°
const permissionMap = useMemo(() => {
  const permissions = {
    quotation: hasPermission('quotation'),
    packing: hasPermission('packing'),
    // ...
  };
  return { permissions, documentTypePermissions, accessibleDocumentTypes };
}, [user, isLoading, hasPermission]); // hasPermission å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“

// ä¿®å¤å - ç›´æ¥ä½¿ç”¨ç”¨æˆ·æƒé™æ•°æ®
const permissionMap = useMemo(() => {
  const userPermissions = user.permissions || [];
  const hasPermissionDirect = (moduleId: string) => {
    const permission = userPermissions.find(p => p.moduleId === moduleId);
    return permission?.canAccess || false;
  };
  
  const permissions = {
    quotation: hasPermissionDirect('quotation'),
    packing: hasPermissionDirect('packing'),
    // ...
  };
  return { permissions, documentTypePermissions, accessibleDocumentTypes };
}, [user, isLoading]); // ç§»é™¤ hasPermission ä¾èµ–
```

#### 2. ä¿®å¤æ€§èƒ½ç›‘æ§ useEffect
```typescript
// ä¿®å¤å‰ - ä¾èµ– user å¯¹è±¡
useEffect(() => {
  if (mounted && !refreshing && user) {
    performanceMonitor.endTimer('dashboard_page_load');
    // ...
  }
}, [mounted, refreshing, user]); // user å¯¹è±¡å˜åŒ–å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“

// ä¿®å¤å - ç§»é™¤ user ä¾èµ–
useEffect(() => {
  if (mounted && !refreshing && user) {
    performanceMonitor.endTimer('dashboard_page_load');
    // ...
  }
}, [mounted, refreshing]); // ç§»é™¤ user ä¾èµ–
```

#### 3. ä¿®å¤æ¨¡å—è¿‡æ»¤ useMemo
```typescript
// ä¿®å¤å‰ - ä¾èµ– hasPermission å‡½æ•°
const availableToolModules = useMemo(() => {
  return TOOL_MODULES.filter(module => hasPermission(module.id));
}, [user, isLoading, hasPermission]);

// ä¿®å¤å - ç›´æ¥ä½¿ç”¨ç”¨æˆ·æƒé™æ•°æ®
const availableToolModules = useMemo(() => {
  const userPermissions = user.permissions || [];
  return TOOL_MODULES.filter(module => {
    const permission = userPermissions.find(p => p.moduleId === module.id);
    return permission?.canAccess || false;
  });
}, [user, isLoading]);
```

#### 4. ä¿®å¤åˆå§‹åŒ– useEffect
```typescript
// ä¿®å¤å‰ - ä¾èµ–ä¸ç¨³å®šçš„å‡½æ•°å¼•ç”¨
useEffect(() => {
  const init = async () => {
    prefetchPages();
    await fetchUser();
  };
  init();
}, [session, status, fetchUser, prefetchPages]);

// ä¿®å¤å - å†…è”å‡½æ•°è°ƒç”¨ï¼Œç§»é™¤ä¸ç¨³å®šä¾èµ–
useEffect(() => {
  const init = async () => {
    // å†…è”é¢„åŠ è½½é€»è¾‘
    if (typeof window !== 'undefined') {
      const coreModules = [
        { path: '/quotation' },
        { path: '/packing' },
        // ...
      ];
      coreModules.forEach(module => {
        router.prefetch(module.path);
      });
    }
    await fetchUser();
  };
  init();
}, [session, status, router]); // ç§»é™¤ fetchUser å’Œ prefetchPages ä¾èµ–
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ä¿®å¤æ‰€æœ‰å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“çš„ä¾èµ–é¡¹

### éªŒè¯ç»“æœ
- âœ… æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
- âœ… æ¶ˆé™¤äº†é¢‘ç¹çš„ Fast Refresh é‡å»º
- âœ… å‡å°‘äº†ä¸å¿…è¦çš„ API è¯·æ±‚
- âœ… æ€§èƒ½ç›‘æ§ä¸å†å¯¼è‡´æ— é™å¾ªç¯
- âœ… æƒé™ç³»ç»Ÿæ­£å¸¸å·¥ä½œ

### æŠ€æœ¯è¦ç‚¹
1. **ä¾èµ–é¡¹ç¨³å®šæ€§**: é¿å…åœ¨ useMemo å’Œ useEffect ä¸­ä¾èµ–ä¸ç¨³å®šçš„å‡½æ•°å¼•ç”¨
2. **ç›´æ¥æ•°æ®è®¿é—®**: ç›´æ¥ä»ç”¨æˆ·æƒé™æ•°æ®è®¡ç®—ï¼Œè€Œä¸æ˜¯è°ƒç”¨å¯èƒ½å˜åŒ–çš„å‡½æ•°
3. **å†…è”é€»è¾‘**: å°†ä¸ç¨³å®šçš„å‡½æ•°è°ƒç”¨å†…è”åˆ° useEffect ä¸­
4. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“å’Œè®¡ç®—

---

## æœ€æ–°ä¿®å¤ - æƒé™åˆ·æ–°APIä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šä¿®æ”¹æƒé™åï¼Œæ‰‹åŠ¨ç‚¹å‡»"åˆ·æ–°æƒé™"èœå•ä»ç„¶æ— æ³•æ˜¾ç¤ºæœ€æ–°æƒé™ã€‚ç»è¿‡æµ‹è¯•å‘ç°ï¼š
1. æƒé™åˆ·æ–°APIè¿”å›"æœåŠ¡å™¨é”™è¯¯"
2. åç«¯APIç«¯ç‚¹ä¸å¯è®¿é—®ï¼ˆ404é”™è¯¯ï¼‰
3. æƒé™åˆ·æ–°é€»è¾‘è°ƒç”¨é”™è¯¯çš„æ–¹æ³•

### æ ¹æœ¬åŸå› åˆ†æ
1. **APIç«¯ç‚¹é—®é¢˜**: åŸAPIå°è¯•è°ƒç”¨å¤–éƒ¨åç«¯æœåŠ¡ `https://udb.luocompany.net/api/admin/users/${userId}`ï¼Œä½†è¯¥ç«¯ç‚¹è¿”å›404
2. **æƒé™åˆ·æ–°é€»è¾‘é”™è¯¯**: `handleRefreshPermissions` è°ƒç”¨ `fetchUser()` è€Œä¸æ˜¯ `refreshPermissions()`
3. **Sessionè·å–å¤±è´¥**: APIæ— æ³•åœ¨ç›´æ¥è°ƒç”¨æ—¶è·å–ç”¨æˆ·session

### ä¿®å¤æªæ–½

#### 1. ä¿®å¤æƒé™åˆ·æ–°é€»è¾‘
```typescript
// ä¿®å¤å‰
const handleRefreshPermissions = useCallback(async () => {
  usePermissionStore.getState().clearUser();
  await fetchUser(); // ä»sessionè·å–ï¼Œä¸æ˜¯æœ€æ–°æƒé™
}, [fetchUser]);

// ä¿®å¤å
const handleRefreshPermissions = useCallback(async () => {
  const { refreshPermissions } = usePermissionStore.getState();
  await refreshPermissions(); // ä»APIè·å–æœ€æ–°æƒé™
}, []);
```

#### 2. ä¿®å¤æƒé™è·å–API
```typescript
// ä¿®å¤å‰ - è°ƒç”¨å¤–éƒ¨API
const response = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/api/admin/users/${userId}`);

// ä¿®å¤å - ä»sessionè·å–æƒé™ï¼Œå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æƒé™
try {
  const session = await getServerSession(authOptions);
  // å¤„ç†sessionä¸­çš„æƒé™æ•°æ®
} catch (sessionError) {
  // ä½¿ç”¨é»˜è®¤æƒé™
  if (isAdmin) {
    permissions = [
      { id: 'default-quotation', moduleId: 'quotation', canAccess: true },
      // ... å…¶ä»–æƒé™
    ];
  }
}
```

#### 3. å¢å¼ºé”™è¯¯å¤„ç†
```typescript
// æ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
return NextResponse.json({ error: `æœåŠ¡å™¨é”™è¯¯: ${errorMessage}` }, { status: 500 });
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ä¿®å¤æƒé™åˆ·æ–°å¤„ç†å‡½æ•°
- `src/app/api/auth/get-latest-permissions/route.ts`: ä¿®å¤APIé€»è¾‘å’Œé”™è¯¯å¤„ç†

### éªŒè¯ç»“æœ
- âœ… APIæ­£å¸¸è¿”å›æƒé™æ•°æ®
- âœ… æƒé™åˆ·æ–°é€»è¾‘è°ƒç”¨æ­£ç¡®çš„æ–¹æ³•
- âœ… é”™è¯¯å¤„ç†æ›´åŠ è¯¦ç»†
- âœ… é»˜è®¤æƒé™æœºåˆ¶ç¡®ä¿åŠŸèƒ½å¯ç”¨

### æŠ€æœ¯è¦ç‚¹
1. **APIè®¾è®¡**: ä»sessionè·å–æƒé™ï¼Œå¤±è´¥æ—¶æä¾›é»˜è®¤æƒé™
2. **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å¸®åŠ©è°ƒè¯•
3. **æƒé™åˆ·æ–°**: ç¡®ä¿è°ƒç”¨æ­£ç¡®çš„APIæ–¹æ³•
4. **å‘åå…¼å®¹**: é»˜è®¤æƒé™ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨

---

## æœ€æ–°ä¿®å¤ - React Hooks è§„åˆ™ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šäº†æŒç»­çš„ React Hooks é”™è¯¯ï¼š
- "Warning: React has detected a change in the order of Hooks called by DashboardPage"
- "Error: Rendered more hooks than during the previous render"
- "Warning: Cannot update a component while rendering a different component"
- é¢‘ç¹çš„ "Fast Refresh rebuilding" æ¶ˆæ¯

### æ ¹æœ¬åŸå› åˆ†æ
1. **setTimeout åŒ…è£…å™¨é—®é¢˜**: å¤šä¸ª `setTimeout(..., 0)` åŒ…è£…å™¨è¢«é‡æ–°å¼•å…¥åˆ° `setState` è°ƒç”¨ä¸­
2. **Hooks é¡ºåºè¿è§„**: é‡å®šå‘ `useEffect` è¢«æ”¾ç½®åœ¨æ¡ä»¶è¿”å›è¯­å¥ä¹‹å
3. **æ¸²æŸ“é˜¶æ®µçŠ¶æ€æ›´æ–°**: åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è°ƒç”¨ `setState` å¯¼è‡´ç»„ä»¶æ›´æ–°å†²çª

### ä¿®å¤æªæ–½

#### 1. ç§»é™¤æ‰€æœ‰ setTimeout åŒ…è£…å™¨
```typescript
// ä¿®å¤å‰
setTimeout(() => {
  setRecentDocuments(sorted);
}, 0);

// ä¿®å¤å
setRecentDocuments(sorted);
```

#### 2. ä¿®å¤ Hooks é¡ºåº
```typescript
// ä¿®å¤å‰ - useEffect åœ¨æ¡ä»¶è¿”å›å
if (!mounted) return null;
if (status === 'loading') return (...);
useEffect(() => {
  if (!session && !user) {
    router.push('/');
  }
}, [session, user, router]);

// ä¿®å¤å - useEffect åœ¨æ¡ä»¶è¿”å›å‰
useEffect(() => {
  if (!session && !user) {
    router.push('/');
  }
}, [session, user, router]);
if (!mounted) return null;
if (status === 'loading') return (...);
```

#### 3. ä¿®å¤äº‹ä»¶ç›‘å¬å™¨å®šä¹‰
```typescript
// ä¿®å¤å‰ - å‡½æ•°å®šä¹‰åœ¨ setTimeout å†…
setTimeout(() => {
  const handleCustomStorageChange = (e: CustomEvent) => {
    // ...
  };
  window.addEventListener('customStorageChange', handleCustomStorageChange);
}, 0);

// ä¿®å¤å - å‡½æ•°å®šä¹‰åœ¨ useEffect é¡¶å±‚
const handleCustomStorageChange = (e: CustomEvent) => {
  // ...
};
window.addEventListener('customStorageChange', handleCustomStorageChange);
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ç§»é™¤æ‰€æœ‰ setTimeout åŒ…è£…å™¨ï¼Œä¿®å¤ hooks é¡ºåº

### éªŒè¯ç»“æœ
- âœ… æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
- âœ… ç§»é™¤äº†æ‰€æœ‰å¯¼è‡´ hooks é¡ºåºé”™è¯¯çš„ setTimeout åŒ…è£…å™¨
- âœ… é‡å®šå‘ useEffect ç°åœ¨åœ¨æ¡ä»¶è¿”å›ä¹‹å‰å£°æ˜
- âœ… äº‹ä»¶ç›‘å¬å™¨å‡½æ•°å®šä¹‰åœ¨æ­£ç¡®çš„ä½œç”¨åŸŸå†…

### æŠ€æœ¯è¦ç‚¹
1. **React Hooks è§„åˆ™**: æ‰€æœ‰ hooks å¿…é¡»åœ¨ç»„ä»¶é¡¶å±‚æ— æ¡ä»¶è°ƒç”¨
2. **æ¸²æŸ“é˜¶æ®µé™åˆ¶**: é¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è°ƒç”¨ setState
3. **äº‹ä»¶ç›‘å¬å™¨ä½œç”¨åŸŸ**: ç¡®ä¿æ¸…ç†å‡½æ•°èƒ½æ­£ç¡®å¼•ç”¨äº‹ä»¶å¤„ç†å‡½æ•°

---

## æœ€æ–°ä¿®å¤ - ç»„ä»¶å¯¼å…¥é”™è¯¯ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šäº†ç»„ä»¶å¯¼å…¥é”™è¯¯ï¼š
- "Attempted import error: '@/components/Header' does not contain a default export"
- "Element type is invalid: expected a string... but got: undefined"

### ä¿®å¤æªæ–½
å°†é»˜è®¤å¯¼å…¥æ”¹ä¸ºå‘½åå¯¼å…¥ï¼š

```typescript
// ä¿®å¤å‰
import Header from '@/components/Header';
import ProfileModal from '@/components/profile/ProfileModal';

// ä¿®å¤å
import { Header } from '@/components/Header';
import { ProfileModal } from '@/components/profile/ProfileModal';
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/dashboard/page.tsx`: ä¿®å¤ Header å’Œ ProfileModal çš„å¯¼å…¥æ–¹å¼

---

## æƒé™åˆ·æ–°é—®é¢˜ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
1. æ‰‹åŠ¨ç‚¹å‡»åˆ·æ–°æƒé™èœå•ï¼Œæ— æ³•æ˜¾ç¤ºæœ€æ–°ç»“æœ
2. ä¸æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œæ–°æƒé™æ— æ³•å‡ºç°
3. æƒé™æ•°æ®æ ¼å¼ä¸ä¸€è‡´

### ä¿®å¤æªæ–½

#### 1. ä¿®æ”¹æƒé™è·å–API
```typescript
// src/app/api/auth/get-latest-permissions/route.ts
// ç›´æ¥ä»åç«¯è·å–æœ€æ–°æƒé™ï¼Œç»•è¿‡ NextAuth ç¼“å­˜
const response = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/api/admin/users/${userId}`, {
  method: 'GET',
  headers: {
    'X-User-ID': userId,
    'X-User-Name': userName,
    'X-User-Admin': isAdmin ? 'true' : 'false'
  }
});
```

#### 2. ä¼˜åŒ–æƒé™å­˜å‚¨æ›´æ–°
```typescript
// src/lib/permissions.ts
// ä½¿ç”¨ cache: 'no-store' ç¡®ä¿è·å–æœ€æ–°æ•°æ®
const response = await fetch('/api/auth/get-latest-permissions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-User-ID': user.id,
    'X-User-Name': user.username,
    'X-User-Admin': user.isAdmin ? 'true' : 'false'
  },
  cache: 'no-store'
});
```

#### 3. ç»Ÿä¸€æƒé™æ•°æ®æ ¼å¼
```typescript
// ç¡®ä¿æ‰€æœ‰æƒé™æ•°æ®éƒ½æ˜¯ Permission[] æ ¼å¼
interface Permission {
  id: string;
  moduleId: string;
  canAccess: boolean;
}
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/api/auth/get-latest-permissions/route.ts`: ç›´æ¥ä»åç«¯è·å–æƒé™
- `src/lib/permissions.ts`: ä¼˜åŒ–æƒé™æ›´æ–°é€»è¾‘
- `src/lib/auth.ts`: ç»Ÿä¸€æƒé™æ•°æ®æ ¼å¼

---

## å¼ºåˆ¶é‡æ–°ç™»å½•é—®é¢˜ä¿®å¤ (2024-12-19)

### é—®é¢˜æè¿°
ä¿®æ”¹æƒé™åè¿”å› dashboard æ—¶ï¼Œä¼šå¼ºåˆ¶è·³è½¬åˆ°ç™»å½•é¡µé¢

### ä¿®å¤æªæ–½

#### 1. ç§»é™¤å¼ºåˆ¶é‡æ–°ç™»å½•é€»è¾‘
```typescript
// src/app/admin/users/[id]/page.tsx
// ç§»é™¤ signOut è°ƒç”¨ï¼Œæ”¹ä¸ºæ˜¾ç¤ºæç¤ºä¿¡æ¯
setSuccessMessage('æƒé™å·²æ›´æ–°ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨åˆ·æ–°æƒé™');
```

#### 2. ä¼˜åŒ– dashboard é‡å®šå‘é€»è¾‘
```typescript
// src/app/dashboard/page.tsx
// åªåœ¨çœŸæ­£æœªç™»å½•æ—¶æ‰é‡å®šå‘
useEffect(() => {
  if (!session && !user) {
    router.push('/');
  }
}, [session, user, router]);
```

#### 3. ä¿®æ”¹ NextAuth session å›è°ƒ
```typescript
// src/lib/auth.ts
// ç›´æ¥ä½¿ç”¨ token ä¸­çš„æƒé™ï¼Œä¸é‡æ–°è·å–
session: (session, token) => {
  return {
    ...session,
    user: {
      ...session.user,
      permissions: token.permissions || []
    }
  };
}
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/admin/users/[id]/page.tsx`: ç§»é™¤å¼ºåˆ¶é‡æ–°ç™»å½•
- `src/app/dashboard/page.tsx`: ä¼˜åŒ–é‡å®šå‘é€»è¾‘
- `src/lib/auth.ts`: ä¼˜åŒ– session å›è°ƒ

---

## åˆå§‹é—®é¢˜ - TypeScript ç±»å‹é”™è¯¯ (2024-12-19)

### é—®é¢˜æè¿°
`å˜é‡"permissions"éšå¼å…·æœ‰"any[]"ç±»å‹ã€‚`

### ä¿®å¤æªæ–½
åœ¨ `src/app/api/auth/get-latest-permissions/route.ts` ä¸­å®šä¹‰æ¥å£å¹¶æ˜ç¡®ç±»å‹ï¼š

```typescript
interface Permission {
  id: string;
  moduleId: string;
  canAccess: boolean;
}

// æ˜ç¡®æŒ‡å®šç±»å‹
const permissions: Permission[] = data.permissions || [];
```

### ä¿®å¤çš„æ–‡ä»¶
- `src/app/api/auth/get-latest-permissions/route.ts`: æ·»åŠ ç±»å‹å®šä¹‰

---

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¿®å¤ï¼Œè§£å†³äº†ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

1. âœ… **TypeScript ç±»å‹é”™è¯¯**: å®šä¹‰äº†æ˜ç¡®çš„ Permission æ¥å£
2. âœ… **æƒé™åˆ·æ–°é—®é¢˜**: å®ç°äº†ç›´æ¥ä»åç«¯è·å–æœ€æ–°æƒé™çš„æœºåˆ¶
3. âœ… **å¼ºåˆ¶é‡æ–°ç™»å½•é—®é¢˜**: ç§»é™¤äº†ä¸å¿…è¦çš„é‡æ–°ç™»å½•é€»è¾‘
4. âœ… **React Hooks é”™è¯¯**: ä¿®å¤äº† hooks é¡ºåºå’Œæ¸²æŸ“é˜¶æ®µçŠ¶æ€æ›´æ–°é—®é¢˜
5. âœ… **ç»„ä»¶å¯¼å…¥é”™è¯¯**: ä¿®å¤äº†å‘½åå¯¼å…¥é—®é¢˜

æ‰€æœ‰ä¿®å¤éƒ½éµå¾ªäº† React æœ€ä½³å®è·µï¼Œç¡®ä¿äº†ä»£ç çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ 