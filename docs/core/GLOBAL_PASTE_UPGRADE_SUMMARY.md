# 全局粘贴升级功能总结

## 🎯 升级目标

让"快速导入"比现有的全局粘贴更顺手：**不用点按钮、随手粘贴就能识别并落表，且容错高**。

## ✅ 实现的4个核心功能

### 1. 全局粘贴捕获（不打扰输入框）
- ✅ 在用户**不聚焦 input/textarea/contenteditable** 时，`Ctrl+V` 直接触发导入逻辑
- ✅ `Shift+Ctrl+V` 触发**替换模式**（清空现有数据）
- ✅ 能识别成功且行数不多（≤ 80 行）→ **直接插入**
- ✅ 否则自动弹出预览（沿用增强的 QuickImport UI）

### 2. 更聪明的解析器
- ✅ **多分隔符支持**：Tab、逗号、分号、连续空格
- ✅ **表头自识别**：自动跳过包含关键字的表头行
- ✅ **2~5列容错**：智能识别多种列模式
  - `名称 数量` (2列)
  - `名称 数量 单价` (3列)  
  - `名称 数量 单位 单价` (4列)
  - `名称 描述 数量 单位 单价` (5列)
- ✅ **货币符号支持**：自动去除 $€¥ 等符号
- ✅ **小数逗号支持**：欧洲格式小数逗号转换
- ✅ **单位规范化**：pcs→pc，个/套/台/件→英文常用短名

### 3. 一键"追加/替换"
- ✅ 默认**追加**到现有数据末尾
- ✅ 按住 **Shift 再粘贴** → 触发**替换**当前表格
- ✅ 粘贴后 toast 摘要："已追加 56 行，跳过 3 行 (name-qty-price)"

### 4. 智能置信度评估
- ✅ 基于成功率、结构稳定性、表头识别的置信度算法
- ✅ 高置信度（≥70%）+ 小数据量（≤80行）→ 直接插入
- ✅ 低置信度或大数据量 → 回退到预览模式
- ✅ 预览界面显示置信度和检测到的格式

## 🚀 新增文件

### A. 智能解析器
**文件：** `src/features/quotation/utils/quickSmartParse.ts`
- 多分隔符解析引擎
- 表头识别逻辑
- 货币和数字格式处理
- 单位标准化映射
- 置信度评估算法

### B. 全局粘贴Hook
**文件：** `src/features/quotation/hooks/useGlobalPasteImport.ts`
- 全局粘贴事件监听
- 输入控件检测（避免干扰正常输入）
- 智能决策机制（直接插入 vs 预览）
- Shift+V 替换模式支持
- Toast 消息集成

### C. 增强的QuickImport组件
**更新：** `src/components/quotation/QuickImport.tsx`
- 支持预设数据自动打开
- 置信度和格式信息显示
- 新旧解析器双重支持
- 增强的用户界面

### D. 表格组件集成
**更新：** `src/components/quotation/ItemsTable.tsx`
- 集成全局粘贴Hook
- 预设数据状态管理
- 用户提示信息更新

## 🎨 用户体验增强

### 视觉反馈
- **置信度指示器**：绿色(≥70%) / 黄色(≥50%) / 红色(<50%)
- **格式检测显示**：显示检测到的数据格式类型
- **增强的Toast**：显示插入行数、跳过行数、检测格式
- **智能提示**：工具栏显示快捷键使用方法

### 交互优化
- **零配置使用**：直接粘贴，无需点击按钮
- **智能容错**：支持多种分隔符和格式
- **快捷键支持**：Ctrl+V 追加，Shift+Ctrl+V 替换
- **非侵入性**：不干扰正常的输入框粘贴

## 📊 支持的数据格式示例

### 基础格式（Tab分隔）
```
名称	数量	单价
苹果	100	2.5
橙子	50	3.0
```

### 带单位格式
```
Product	Qty	Unit	Price
Apple	100	pc	$2.50
Orange	50	kg	€3.00
```

### 带描述格式
```
Name	Description	Qty	Unit	Price
Apple	Fresh Red Apple	100	pc	2.50
Orange	Organic Orange	50	kg	3.00
```

### 逗号分隔格式
```
名称,数量,单价
苹果,100,2.5
橙子,50,3.0
```

### 自动单位转换
- `pcs` → `pc`
- `个/件/台` → `pc`  
- `套/组` → `set`
- 保留未知单位

## 🔧 配置选项

在 `useGlobalPasteImport` 中可配置：
- `enabled`: 是否启用全局粘贴（默认true）
- `maxDirectInsert`: 直接插入的最大行数阈值（默认80）
- `minConfidence`: 最小置信度阈值（默认0.7）
- `onFallbackPreview`: 回退到预览的回调函数

## 🎯 使用体验

### 常见使用场景
1. **直接粘贴**：在表格区域（非输入框）按 `Ctrl+V`
   - 高置信度小数据 → 直接插入，显示成功toast
   - 低置信度或大数据 → 自动打开预览框
2. **替换模式**：按住 `Shift` 再按 `Ctrl+V` → 替换全部数据
3. **手动预览**：点击"导入"按钮，手动粘贴和预览

### 错误处理
- 自动跳过空行和无效行
- 智能识别表头并跳过
- 容错处理各种分隔符混用
- 提供详细的跳过行数统计

## 🌟 核心优势

1. **无缝体验**：真正的"手到粘来"，无需点击按钮
2. **智能识别**：支持多种格式，自动适配
3. **高容错性**：处理各种不规范的数据格式
4. **非侵入式**：不影响现有的输入体验
5. **渐进增强**：完全兼容现有功能
6. **即时反馈**：清晰的状态指示和操作提示

这个升级让导入功能从"够用"提升到"好用"，真正实现了比全局粘贴更顺手的体验！
