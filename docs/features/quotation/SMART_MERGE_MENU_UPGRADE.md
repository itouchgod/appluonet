# 智能合并菜单升级

## 🎯 升级目标

将右键菜单中的"合并到第几行"功能升级为智能合并，根据当前行的位置自动提供向上合并和向下合并的选项。

## 🔄 功能改进

### 原有功能
- 只有向下合并选项
- 固定的合并范围（+2行、+4行）
- 不考虑当前行位置

### 新功能
- **智能方向判断**: 根据当前行位置提供向上或向下合并
- **动态范围计算**: 根据边界自动调整合并范围
- **清晰的操作提示**: 明确显示合并方向

## 📊 智能合并逻辑

### 向上合并
- **触发条件**: 当前行不是第一行（rowIndex > 0）
- **合并范围**: 向上合并2行或3行
- **操作说明**: "向上合并"、"向上合并更多"

### 向下合并
- **触发条件**: 当前行不是最后一行（rowIndex < data.items.length - 1）
- **合并范围**: 向下合并2行或3行
- **操作说明**: "向下合并"、"向下合并更多"

### 边界处理
- **第一行**: 只显示向下合并选项
- **最后一行**: 只显示向上合并选项
- **中间行**: 同时显示向上和向下合并选项

## 🎨 用户体验

### 菜单结构
```
右键菜单
├── 向上合并 (如果不在第一行)
├── 向上合并更多 (如果不在第一行)
├── 向下合并 (如果不在最后一行)
├── 向下合并更多 (如果不在最后一行)
├── ───────────────── (分隔线)
├── 拆分合并单元格
└── 取消
```

### 视觉改进
- **方向标识**: 明确显示"向上"或"向下"
- **分隔线**: 区分合并操作和其他操作
- **动态显示**: 根据位置智能显示相关选项

## 🔧 技术实现

### 核心逻辑
```typescript
// 向上合并选项
{contextMenu.rowIndex > 0 && (
  <>
    <button onClick={() => {
      const startRow = Math.max(contextMenu.rowIndex - 2, 0);
      mergeToRow(startRow, contextMenu.rowIndex);
    }}>
      向上合并
    </button>
    <button onClick={() => {
      const startRow = Math.max(contextMenu.rowIndex - 3, 0);
      mergeToRow(startRow, contextMenu.rowIndex);
    }}>
      向上合并更多
    </button>
  </>
)}

// 向下合并选项
{contextMenu.rowIndex < data.items.length - 1 && (
  <>
    <button onClick={() => {
      const endRow = Math.min(contextMenu.rowIndex + 2, data.items.length - 1);
      mergeToRow(contextMenu.rowIndex, endRow);
    }}>
      向下合并
    </button>
    <button onClick={() => {
      const endRow = Math.min(contextMenu.rowIndex + 4, data.items.length - 1);
      mergeToRow(contextMenu.rowIndex, endRow);
    }}>
      向下合并更多
    </button>
  </>
)}
```

### 边界保护
- **Math.max()**: 确保向上合并不会超出第一行
- **Math.min()**: 确保向下合并不会超出最后一行
- **条件渲染**: 只在合适的位置显示相应选项

## 📋 使用场景

### 场景1: 第一行
- **可用操作**: 向下合并2行、向下合并3行
- **示例**: 第1行右键 → "向下合并"、"向下合并更多"

### 场景2: 中间行
- **可用操作**: 向上合并2行、向上合并3行、向下合并2行、向下合并3行
- **示例**: 第5行右键 → "向上合并"、"向上合并更多"、"向下合并"、"向下合并更多"

### 场景3: 最后一行
- **可用操作**: 向上合并2行、向上合并3行
- **示例**: 第10行右键 → "向上合并"、"向上合并更多"

## ✅ 功能优势

### 1. 智能性
- **自动判断方向**: 根据位置自动提供合适的合并选项
- **动态范围**: 根据边界自动调整合并范围
- **避免无效操作**: 不会提供超出边界的合并选项

### 2. 直观性
- **方向明确**: 清楚显示"向上"或"向下"
- **操作简洁**: 简化的菜单文字，更易理解
- **操作简单**: 一键完成合并操作

### 3. 完整性
- **覆盖所有场景**: 第一行、中间行、最后一行都有合适的选项
- **保持原有功能**: 拆分合并单元格功能保持不变
- **向后兼容**: 不影响现有的自动合并功能

## 🚀 总结

这次升级：
1. **提升了用户体验**: 更直观的合并操作
2. **增强了智能性**: 根据位置自动提供合适选项
3. **保持了完整性**: 所有原有功能都保留
4. **优化了界面**: 更清晰的菜单结构

现在用户可以更智能、更直观地进行手动合并操作！
