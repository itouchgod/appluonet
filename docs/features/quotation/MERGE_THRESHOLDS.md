# 合并门槛 - PDF字体系统

## 性能阈值要求

### 核心指标
- **loading** ≤ 50ms（首次 ≤ 120ms 可告警不拦截）
- **registration** ≤ 15ms（首次 ≤ 40ms）
- **generation** ≤ 200ms（表格复杂场景 ≤ 350ms）
- **控制台零警告**（直接当失败处理）

### 健康检查要求
- ✅ 字体注册成功（normal + bold）
- ✅ setFont 调用正常
- ✅ AutoTable 渲染正常
- ✅ Blob 生成成功
- ✅ 文件大小 > 1KB
- ✅ 总耗时 < 500ms（CI环境）

## 检查清单

### 开发环境
- [ ] 启动后自动运行健康检查
- [ ] 控制台无字体警告
- [ ] 性能监控报告正常
- [ ] 预热机制工作正常

### CI环境
- [ ] 构建成功
- [ ] 健康检查通过
- [ ] 无字体注册警告
- [ ] 性能指标达标

### 生产环境
- [ ] 字体加载正常
- [ ] PDF生成稳定
- [ ] 用户体验良好
- [ ] 错误处理完善

## 故障排查

### 常见问题
1. **字体注册失败**
   - 检查 base64 格式（无 data: 前缀）
   - 确认 normal/bold 都注册
   - 验证版本号同步

2. **性能回退**
   - 检查预热是否成功
   - 查看性能监控报告
   - 确认缓存机制正常

3. **控制台警告**
   - 检查字体名称一致性
   - 确认注册顺序正确
   - 验证 doc 实例唯一性

### 紧急修复
如果发现字体问题，按以下步骤处理：

1. **立即回滚**到上一个稳定版本
2. **检查字体文件**是否损坏
3. **验证版本号**是否同步
4. **清除缓存**重新测试
5. **更新文档**记录问题

## 监控告警

### 自动告警
- 性能超阈值：console.warn
- 字体注册失败：console.error
- 健康检查失败：CI失败

### 手动检查
```bash
# 运行健康检查
npm run healthcheck

# 查看性能报告
npm run performance-report

# 检查字体状态
npm run font-status
```

## 升级流程

### 字体文件升级
1. 更新字体文件
2. 修改 `FONT_VERSION`
3. 清除浏览器缓存
4. 运行健康检查
5. 部署测试环境
6. 确认无问题后合并

### 依赖升级
1. 更新依赖版本
2. 运行健康检查
3. 测试PDF生成
4. 确认兼容性
5. 更新文档

## 质量保证

### 自动化测试
- ✅ 单元测试覆盖
- ✅ 集成测试验证
- ✅ E2E测试检查
- ✅ 性能测试监控

### 手动验证
- ✅ 开发环境测试
- ✅ 测试环境验证
- ✅ 生产环境监控
- ✅ 用户反馈收集

### 文档维护
- ✅ 技术文档更新
- ✅ 用户指南完善
- ✅ 故障排查指南
- ✅ 性能优化建议
