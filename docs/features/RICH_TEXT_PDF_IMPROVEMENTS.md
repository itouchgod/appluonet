# 富文本PDF渲染改进说明

## 概述

本次改进主要解决了采购模块中富文本编辑器的两个关键问题：

1. **工具栏图标不清晰**：将原来的字符图标（⫷ ⫸ ⫹ ⫺）替换为清晰的SVG图标
2. **PDF呈现问题**：统一行高、修复表格显示问题、优化间距

## 改进详情

### 1. 工具栏图标优化

#### 问题描述
- 原来的对齐按钮使用特殊字符：⫷ ⫸ ⫹ ⫺
- 在不同字体下显示效果不一致
- 用户难以理解按钮功能

#### 解决方案
- 使用SVG图标替换字符图标
- 保持所有 `execCommand('justify*')` 行为不变
- 图标更清晰、语义更明确

#### 图标映射
- 左对齐：`M3 6h14v2H3V6zm0 5h18v2H3v-2zm0 5h12v2H3v-2z`
- 居中对齐：`M5 6h14v2H5V6zm0 5h18v2H5v-2zm0 5h14v2H5v-2z`
- 右对齐：`M7 6h14v2H7V6zm3 5h11v2H10v-2zm7 5h7v2h-7v-2z`
- 两端对齐：`M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z`

### 2. PDF呈现优化

#### 问题描述
- 段落、列表、单元格行高不一致
- 文本后接表格时表格不显示
- 表格上下间距过大
- 单元格行高过高，内容贴左上角

#### 解决方案

##### A. HTML预处理函数
新增 `preprocessRichHTML()` 函数，在PDF渲染前统一HTML样式：

```typescript
export function preprocessRichHTML(html: string): string {
  // 统一行高为 1.35
  // 表格上下间距为 6px
  // 单元格内边距为 6px，顶部对齐
  // 移除空段落，转换图片为占位符
}
```

##### B. 表格渲染优化
- 使用 `calcCellHeight()` 精确计算单元格行高
- 行高 = 文本行数 × 字体大小 × 1.35 + 12px内边距
- 支持多行文本自动换行
- 单元格内容顶部对齐

##### C. 流式渲染修复
在 `renderRichTextInPDF()` 中特殊处理表格：
- 遇到 `<table>` 时先添加6pt间距
- 调用 `renderTableInPDF()` 渲染表格
- 渲染完成后继续处理后续内容
- 确保表格不被"吞掉"

## 技术实现

### 文件修改清单

1. **`src/components/ui/RichTextEditor.tsx`**
   - 替换对齐按钮图标为SVG
   - 优化代码结构，移除调试日志
   - 改进表格插入样式（6px间距）

2. **`src/utils/purchasePdfGenerator.ts`**
   - 新增 `preprocessRichHTML()` 函数
   - 在富文本渲染前调用预处理
   - 确保HTML内容标准化

3. **`src/utils/tableRenderer.ts`**
   - 新增 `calcCellHeight()` 函数
   - 新增 `drawCell()` 函数
   - 优化行高计算逻辑
   - 统一参数：`CELL_PADDING_X = 6`, `CELL_PADDING_Y = 6`, `LINE_HEIGHT = 1.35`

### 核心参数

```typescript
// 统一的行高和间距参数
const CELL_PADDING_X = 6;        // 单元格水平内边距
const CELL_PADDING_Y = 6;        // 单元格垂直内边距
const LINE_HEIGHT = 1.35;        // 行高倍数
const spacingAroundTable = 6;    // 表格上下间距（pt）
```

## 使用效果

### 改进前
- ❌ 工具栏图标模糊不清
- ❌ PDF中段落行高不一致
- ❌ 表格经常不显示
- ❌ 单元格内容贴左上角
- ❌ 表格间距过大

### 改进后
- ✅ 工具栏图标清晰明确
- ✅ PDF中所有文本行高统一（1.35倍）
- ✅ 表格正常显示，不会被"吞掉"
- ✅ 单元格内容顶部对齐，行高自适应
- ✅ 表格上下间距适中（6pt）

## 测试验证

### 测试用例

1. **工具栏图标测试**
   - 验证所有对齐按钮显示SVG图标
   - 确认 `execCommand` 行为正常

2. **HTML预处理测试**
   - 验证行高、表格样式、单元格样式统一
   - 确认空段落移除和图片转换

3. **表格行高测试**
   - 验证多行文本自动换行
   - 确认行高计算准确

4. **PDF渲染测试**
   - 验证富文本到PDF的完整流程
   - 确认表格显示和间距正确

### 运行测试

⚠️ **注意：测试文件已被移除**

由于富文本功能已被移除，相关的测试文件也已删除。如需验证PDF功能，请在采购模块中直接测试PDF导出功能。

## 注意事项

1. **向后兼容**：所有现有功能保持不变，仅优化显示效果
2. **性能影响**：HTML预处理增加少量计算开销，但提升PDF质量
3. **字体依赖**：SVG图标使用 `currentColor`，自动适配主题
4. **错误处理**：预处理函数包含完整的错误处理，失败时返回原HTML

## 后续优化建议

1. **更多图标**：为其他工具栏按钮也添加SVG图标
2. **主题适配**：根据深色/浅色主题调整图标颜色
3. **性能监控**：添加PDF生成性能监控
4. **用户反馈**：收集用户对改进效果的反馈

## 总结

本次改进显著提升了采购模块富文本编辑器的用户体验和PDF输出质量：

- **视觉改进**：工具栏图标更清晰、专业
- **功能修复**：解决了表格显示和行高不一致问题
- **代码优化**：统一参数、优化函数结构
- **用户体验**：PDF输出更美观、易读

这些改进为后续功能扩展奠定了良好基础，提升了整个系统的专业性和可用性。
