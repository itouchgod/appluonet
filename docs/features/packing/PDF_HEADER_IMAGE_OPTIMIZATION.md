# Packing模块PDF表头图片比例优化

## 功能概述

针对packing模块PDF生成中表头图片在横向和纵向模式下的比例问题，优化了图片的尺寸计算和布局，确保图片在不同页面方向下都能保持正确的宽高比。

## 主要优化

### 1. 图片比例保持
- **宽高比计算**: 正确计算图片的原始宽高比
- **比例保持**: 确保图片在缩放时不会变形
- **自适应调整**: 根据页面方向自动调整图片尺寸

### 2. 横向模式优化
- **保持纵向尺寸**: 使用与纵向模式相同的图片尺寸，不根据横向纸张宽度缩放
- **标准宽度**: 使用A4纵向模式的标准宽度(210-30=180mm)
- **最大高度限制**: 40mm，与纵向模式保持一致
- **居中显示**: 图片水平居中显示
- **统一布局**: 与纵向模式保持相同的上边距和间距

### 3. 纵向模式优化
- **最大高度限制**: 40mm，允许更大的显示空间
- **最大宽度限制**: 页面宽度减去30mm边距
- **居中显示**: 图片水平居中显示
- **标准布局**: 保持标准的上边距和间距

## 实现细节

### 1. 图片比例计算
```typescript
// 计算图片的原始宽高比
const aspectRatio = imgProperties.width / imgProperties.height;

// 横向模式优化
if (shouldUseCompactHeader) {
  // 横向模式且显示marks列：保持与纵向模式相同的图片尺寸
  // 使用纵向模式的标准尺寸，而不是根据横向纸张宽度缩放
  const standardWidth = 210 - 30; // A4纵向模式的宽度减去30mm边距
  const maxHeight = 40; // 与纵向模式保持一致的最大高度
  
  // 使用纵向模式的标准宽度计算
  imgWidth = standardWidth;
  imgHeight = imgWidth / aspectRatio;
  
  // 如果高度超出限制，则按高度计算宽度
  if (imgHeight > maxHeight) {
    imgHeight = maxHeight;
    imgWidth = imgHeight * aspectRatio;
  }
  
  imgX = (pageWidth - imgWidth) / 2; // 水平居中
  imgY = 15; // 与纵向模式保持相同的上边距
}

// 纵向模式优化
else {
  const maxHeight = 40; // 纵向模式下允许更大的高度
  const maxWidth = pageWidth - 30; // 左右各留15mm
  
  // 先按宽度计算高度
  imgWidth = maxWidth;
  imgHeight = imgWidth / aspectRatio;
  
  // 如果高度超出限制，则按高度计算宽度
  if (imgHeight > maxHeight) {
    imgHeight = maxHeight;
    imgWidth = imgHeight * aspectRatio;
  }
  
  imgX = (pageWidth - imgWidth) / 2; // 水平居中
  imgY = 15; // 上边距15mm
}
```

### 2. 尺寸限制策略
- **宽度优先**: 先按最大宽度计算，确保图片充分利用水平空间
- **高度限制**: 如果计算出的高度超出限制，则按最大高度重新计算
- **比例保持**: 在重新计算时保持原始宽高比

### 3. 布局优化
- **水平居中**: 图片在页面中水平居中显示
- **边距调整**: 根据页面方向调整上边距
- **间距优化**: 调整图片与标题之间的间距

## 优化效果

### 1. 图片显示
- **比例正确**: 图片不会出现拉伸或压缩变形
- **尺寸合适**: 在不同页面方向下都有合适的显示尺寸
- **视觉效果**: 保持图片的清晰度和美观度

### 2. 空间利用
- **横向模式**: 图片保持与纵向模式相同的尺寸，不占用过多空间
- **纵向模式**: 图片高度限制在40mm，充分利用垂直空间
- **整体布局**: 图片、标题和表格的布局更加协调

### 3. 一致性
- **比例一致**: 横向和纵向模式下图片都保持相同的宽高比
- **居中一致**: 两种模式下图片都水平居中显示
- **质量一致**: 图片在不同模式下都保持清晰度

## 使用场景

### 1. 横向模式
- 当显示marks列时，自动启用横向模式
- 图片保持与纵向模式相同的尺寸，确保视觉一致性
- 图片水平居中，视觉效果良好

### 2. 纵向模式
- 不显示marks列时，使用纵向模式
- 图片高度限制在40mm，充分利用垂直空间
- 图片水平居中，保持标准布局

## 技术实现

### 1. 比例计算
- 使用`imgProperties.width / imgProperties.height`计算原始宽高比
- 在缩放时保持这个比例，避免图片变形

### 2. 尺寸限制
- 设置最大宽度和最大高度限制
- 优先按宽度计算，必要时按高度重新计算

### 3. 布局控制
- 使用`(pageWidth - imgWidth) / 2`实现水平居中
- 根据页面方向调整上边距和间距

## 更新日志

### 2025-01-08
- ✅ **PDF表头图片比例优化**: 修复横向和纵向模式下图片比例不一致的问题
- ✅ **宽高比保持**: 正确计算和保持图片的原始宽高比
- ✅ **尺寸一致性**: 横向模式下保持与纵向模式相同的图片尺寸
- ✅ **横向模式优化**: 使用纵向模式的标准宽度，避免图片过大
- ✅ **纵向模式优化**: 限制图片高度为40mm，充分利用垂直空间
- ✅ **居中显示**: 两种模式下图片都水平居中显示
