# PDF健康检查指南

## 概述

MLUONET系统包含一个PDF性能健康检查机制，用于监控PDF生成性能和字体加载状态。这个机制主要在开发环境中运行，帮助开发者及时发现性能问题。

## 健康检查机制

### 检查内容
1. **字体注册状态**: 检查中文字体是否正确注册
2. **PDF生成性能**: 测试PDF生成耗时
3. **AutoTable功能**: 验证表格生成功能
4. **文件大小**: 检查生成的PDF文件大小

### 性能阈值
```typescript
const HEALTH_THRESHOLDS = {
  EXCELLENT: 2000,  // <2000ms: 通过
  WARNING: 4000,    // 2000-4000ms: 警告
  CRITICAL: 8000,   // >4000ms: 失败
}
```

### 日志级别
- **通过**: 性能优秀，无问题
- **警告**: 性能较慢，但不影响功能
- **失败**: 性能问题严重，需要优化

## 常见问题

### 1. 健康检查"失败"但PDF功能正常
**原因**: 健康检查阈值设置过于严格
**解决**: 已调整阈值，现在2000ms内都算通过

### 2. 首次加载较慢
**原因**: 字体需要首次下载和注册
**解决**: 系统已实现字体缓存，后续加载会很快

### 3. 开发环境日志过多
**原因**: 健康检查在开发环境频繁运行
**解决**: 已优化日志级别，警告不再显示为错误

## 性能优化建议

### 1. 字体优化
- 使用压缩字体文件(.gz)
- 启用字体缓存
- 预加载常用字体

### 2. PDF生成优化
- 使用AutoTable的wrap模式
- 避免过大的表格数据
- 合理设置字体大小

### 3. 缓存策略
- 启用IndexedDB字体缓存
- 图片转换为dataURL缓存
- 避免重复加载资源

## 监控指标

### 关键指标
- **字体加载时间**: 目标 < 200ms
- **PDF生成时间**: 目标 < 2000ms
- **文件大小**: 根据内容合理控制

### 日志示例
```
[healthcheck] 开发环境健康检查通过: 生成 97158 bytes PDF，0 个警告，0 个错误
[healthcheck] 开发环境健康检查警告: 生成 97158 bytes PDF，0 个警告，0 个错误
[healthcheck] 开发环境健康检查失败: 生成 97158 bytes PDF，0 个警告，1 个错误
```

## 故障排除

### 1. 健康检查不运行
- 检查是否在开发环境
- 确认ClientInitializer组件已加载
- 查看控制台是否有错误

### 2. 性能持续较差
- 检查网络连接
- 确认字体文件是否正常
- 查看是否有其他资源竞争

### 3. 字体加载失败
- 检查字体文件路径
- 确认浏览器支持
- 查看IndexedDB状态

## 配置说明

### 环境变量
- `NODE_ENV=development`: 启用开发环境健康检查
- `NODE_ENV=production`: 禁用健康检查

### 自定义阈值
可以在 `src/utils/pdfFontHealthcheck.ts` 中调整阈值：
```typescript
const HEALTH_THRESHOLDS = {
  EXCELLENT: 2000,  // 优秀阈值
  WARNING: 4000,    // 警告阈值
  CRITICAL: 8000,   // 失败阈值
}
```

## 总结

PDF健康检查是一个开发工具，用于监控和优化PDF生成性能。通过合理的阈值设置和日志分级，可以及时发现性能问题而不影响正常开发流程。
