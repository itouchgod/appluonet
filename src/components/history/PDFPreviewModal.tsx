'use client';

import { useState, useEffect, useCallback } from 'react';
import { X, FileText, Download, ExternalLink, Smartphone } from 'lucide-react';
import { generateQuotationPDF } from '@/utils/quotationPdfGenerator';
import { generateOrderConfirmationPDF } from '@/utils/orderConfirmationPdfGenerator';
import { generateInvoicePDF } from '@/utils/invoicePdfGenerator';
import { generatePurchaseOrderPDF } from '@/utils/purchasePdfGenerator';
import { generatePackingListPDF } from '@/utils/packingPdfGenerator';
import { getDeviceInfo, handlePDFPreview, openPDFInNewTab } from '@/utils/pdfHelpers';

interface PreviewHistoryItem {
  data: unknown;
  quotationNo?: string;
  invoiceNo?: string;
  orderNo?: string;
  pdfBlob?: Blob; // Áõ¥Êé•‰º†ÈÄíÁöÑPDF blob
  pdfUrl?: string; // Êñ∞Â¢ûÔºöÁõ¥Êé•‰º†ÈÄíÁöÑPDF URL
}

interface PDFPreviewModalProps {
  isOpen: boolean;
  onClose: () => void;
  item: PreviewHistoryItem | null;
  itemType: 'quotation' | 'confirmation' | 'invoice' | 'purchase' | 'packing';
}

interface DeviceInfo {
  isAndroid: boolean;
  canPreviewPDF: boolean;
  browser?: {
    name: string;
  };
  recommendedAction?: string;
}

interface PreviewInfo {
  canPreview: boolean;
  shouldUseFallback: boolean;
  fallbackType: string;
  message: string;
  showDownloadButton: boolean;
  showOpenInNewTab: boolean;
}

export default function PDFPreviewModal({ isOpen, onClose, item, itemType }: PDFPreviewModalProps) {
  const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
  const [pdfPreviewUrl, setPdfPreviewUrl] = useState<string | null>(null);
  const [showDownloadFallback, setShowDownloadFallback] = useState(false);
  const [deviceInfo, setDeviceInfo] = useState<DeviceInfo | null>(null);
  const [previewInfo, setPreviewInfo] = useState<PreviewInfo>({
    canPreview: false,
    shouldUseFallback: true,
    fallbackType: 'download',
    message: 'Ê≠£Âú®ÂàùÂßãÂåñÈ¢ÑËßà...',
    showDownloadButton: true,
    showOpenInNewTab: true
  });

  // Âú®ÂÆ¢Êà∑Á´ØÁéØÂ¢É‰∏ãËé∑ÂèñËÆæÂ§á‰ø°ÊÅØ
  useEffect(() => {
    if (typeof window !== 'undefined') {
      try {
        const info = getDeviceInfo();
        setDeviceInfo(info);
        
        if (info.isAndroid || !info.canPreviewPDF) {
          setShowDownloadFallback(true);
        }
      } catch (error) {
        console.warn('Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØÂ§±Ë¥•:', error);
        setShowDownloadFallback(true);
      }
    }
  }, []);

  // Êõ¥Êñ∞È¢ÑËßà‰ø°ÊÅØ
  useEffect(() => {
    if (typeof window !== 'undefined' && deviceInfo) {
      try {
        const info = handlePDFPreview(pdfPreviewUrl, {
          autoDetectDevice: true,
          forceAndroidFallback: true
        });
        setPreviewInfo(info);
      } catch (error) {
        console.warn('Â§ÑÁêÜPDFÈ¢ÑËßàÂ§±Ë¥•:', error);
        setShowDownloadFallback(true);
        // ËÆæÁΩÆÈªòËÆ§ÁöÑÈ¢ÑËßà‰ø°ÊÅØ
        setPreviewInfo({
          canPreview: false,
          shouldUseFallback: true,
          fallbackType: 'download',
          message: 'PDFÈ¢ÑËßàÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑‰∏ãËΩΩÊü•Áúã',
          showDownloadButton: true,
          showOpenInNewTab: true
        });
      }
    }
  }, [pdfPreviewUrl, deviceInfo]);

  // ÁîüÊàêPDFÈ¢ÑËßà
  const generatePdfPreview = useCallback(async () => {
    if (!item || !item.data) {
      console.warn('È¢ÑËßàÊï∞ÊçÆ‰∏çÂÆåÊï¥');
      setShowDownloadFallback(true);
      return;
    }

    setIsGeneratingPdf(true);
    setPdfPreviewUrl(null);
    
    try {
      let pdfUrl: string | null = null;

      // ‰ºòÂÖà‰ΩøÁî®Â∑≤‰º†ÈÄíÁöÑpdfUrlÔºåÈÅøÂÖçÈáçÂ§çÁîüÊàê
      if (item.pdfUrl) {
        pdfUrl = item.pdfUrl;
      } else if (item.pdfBlob) {
        // Â¶ÇÊûúÊúâpdfBlobÔºåËΩ¨Êç¢‰∏∫URL
        pdfUrl = URL.createObjectURL(item.pdfBlob);
      } else {
        // ÊúÄÂêéÊâçÊ†πÊçÆËÆ∞ÂΩïÁ±ªÂûãÁîüÊàêÂØπÂ∫îÁöÑPDF
        if (itemType === 'quotation' || itemType === 'confirmation') {
          // ‰ΩøÁî®Êñ∞ÁöÑgeneratePdfÊúçÂä°Êù•Â§ÑÁêÜÊä•‰ª∑ÂçïÂíåËÆ¢ÂçïÁ°ÆËÆ§
          const { generatePdf } = await import('@/features/quotation/services/generate.service');
          
          // ‰ªéÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ‰∏≠ÊèêÂèñnotesConfig
          const quotationData = item.data as any;
          const notesConfig = quotationData.notesConfig || [];
          
          // üÜï ‰ªéÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ‰∏≠ÊèêÂèñ‰øùÂ≠òÊó∂ÁöÑÂàóÊòæÁ§∫ËÆæÁΩÆ
          const savedVisibleCols = quotationData.savedVisibleCols || null;
          
          // ‰ΩøÁî®Êñ∞ÁöÑÁîüÊàêÊúçÂä°Ôºå‰º†ÂÖ•notesConfigÂíå‰øùÂ≠òÊó∂ÁöÑÂàóÊòæÁ§∫ËÆæÁΩÆ
          const pdfBlob = await generatePdf(
            itemType, 
            quotationData, 
            notesConfig, 
            (progress) => {
              // È¢ÑËßàÊó∂‰∏çÈúÄË¶ÅÊòæÁ§∫ËøõÂ∫¶
              console.log(`PDFÁîüÊàêËøõÂ∫¶: ${progress}%`);
            }, 
            { 
              mode: 'preview',
              savedVisibleCols // üÜï ‰º†ÈÄí‰øùÂ≠òÊó∂ÁöÑÂàóÊòæÁ§∫ËÆæÁΩÆ
            }
          );
          pdfUrl = URL.createObjectURL(pdfBlob);
        } else if (itemType === 'invoice') {
          // ‰ΩøÁî®PDFÊúçÂä°Êù•Â§ÑÁêÜÊï∞ÊçÆËΩ¨Êç¢
          const { PDFService } = await import('@/features/invoice/services/pdf.service');
          const pdfBlob = await PDFService.generateInvoicePDF(item.data as any);
          pdfUrl = URL.createObjectURL(pdfBlob);
        } else if (itemType === 'purchase') {
          // @ts-ignore - ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆÂèØËÉΩÊù•Ëá™‰∏çÂêåÊù•Ê∫ê
          const pdfBlob = await generatePurchaseOrderPDF(item.data, true);
          pdfUrl = URL.createObjectURL(pdfBlob);
        } else if (itemType === 'packing') {
          // @ts-ignore - ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆÂèØËÉΩÊù•Ëá™‰∏çÂêåÊù•Ê∫ê
          const packingData = item.data as any;
          const savedVisibleCols = packingData.savedVisibleCols || null;
          const pdfBlob = await generatePackingListPDF(packingData, undefined, savedVisibleCols);
          pdfUrl = URL.createObjectURL(pdfBlob);
        }
      }

      if (pdfUrl) {
        setPdfPreviewUrl(pdfUrl);
        // ÂÆâÂçìËÆæÂ§á‰∏çÂ∞ùËØïiframeÈ¢ÑËßàÔºåÁõ¥Êé•ÊòæÁ§∫fallback
        if (deviceInfo?.isAndroid) {
          setShowDownloadFallback(true);
        }
      }
    } catch (error) {
      console.error('ÁîüÊàêPDFÈ¢ÑËßàÂ§±Ë¥•:', error);
      setShowDownloadFallback(true);
    } finally {
      setIsGeneratingPdf(false);
    }
  }, [item, itemType, deviceInfo]);

  // ‰∏ãËΩΩPDF
  const downloadPDF = async () => {
    if (!item || !item.data) {
      console.warn('‰∏ãËΩΩÊï∞ÊçÆ‰∏çÂÆåÊï¥');
      alert('PDF‰∏ãËΩΩÂ§±Ë¥•ÔºåÊï∞ÊçÆ‰∏çÂÆåÊï¥');
      return;
    }

    setIsGeneratingPdf(true);
    try {
      let pdfBlob: Blob;

      // Â¶ÇÊûúitem‰∏≠Â∑≤ÁªèÂåÖÂê´pdfBlobÔºåÁõ¥Êé•‰ΩøÁî®
      if (item.pdfBlob) {
        pdfBlob = item.pdfBlob;
      } else {
        // Ê†πÊçÆËÆ∞ÂΩïÁ±ªÂûãÁîüÊàêÂØπÂ∫îÁöÑPDF
        if (itemType === 'quotation' || itemType === 'confirmation') {
          // ‰ΩøÁî®Êñ∞ÁöÑgeneratePdfÊúçÂä°Êù•Â§ÑÁêÜÊä•‰ª∑ÂçïÂíåËÆ¢ÂçïÁ°ÆËÆ§
          const { generatePdf } = await import('@/features/quotation/services/generate.service');
          
          // ‰ªéÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ‰∏≠ÊèêÂèñnotesConfig
          const quotationData = item.data as any;
          const notesConfig = quotationData.notesConfig || [];
          
          // üÜï ‰ªéÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ‰∏≠ÊèêÂèñ‰øùÂ≠òÊó∂ÁöÑÂàóÊòæÁ§∫ËÆæÁΩÆ
          const savedVisibleCols = quotationData.savedVisibleCols || null;
          
          // ‰ΩøÁî®Êñ∞ÁöÑÁîüÊàêÊúçÂä°Ôºå‰º†ÂÖ•notesConfigÂíå‰øùÂ≠òÊó∂ÁöÑÂàóÊòæÁ§∫ËÆæÁΩÆ
          pdfBlob = await generatePdf(
            itemType, 
            quotationData, 
            notesConfig, 
            (progress) => {
              // ‰∏ãËΩΩÊó∂‰∏çÈúÄË¶ÅÊòæÁ§∫ËøõÂ∫¶
              console.log(`PDFÁîüÊàêËøõÂ∫¶: ${progress}%`);
            }, 
            { 
              mode: 'final',
              savedVisibleCols // üÜï ‰º†ÈÄí‰øùÂ≠òÊó∂ÁöÑÂàóÊòæÁ§∫ËÆæÁΩÆ
            }
          );
        } else if (itemType === 'invoice') {
          // ‰ΩøÁî®PDFÊúçÂä°Êù•Â§ÑÁêÜÊï∞ÊçÆËΩ¨Êç¢
          const { PDFService } = await import('@/features/invoice/services/pdf.service');
          pdfBlob = await PDFService.generateInvoicePDF(item.data as any);
        } else if (itemType === 'purchase') {
          // @ts-ignore - ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆÂèØËÉΩÊù•Ëá™‰∏çÂêåÊù•Ê∫ê
          pdfBlob = await generatePurchaseOrderPDF(item.data, false);
        } else if (itemType === 'packing') {
          // @ts-ignore - ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆÂèØËÉΩÊù•Ëá™‰∏çÂêåÊù•Ê∫ê
          const packingData = item.data as any;
          const savedVisibleCols = packingData.savedVisibleCols || null;
          pdfBlob = await generatePackingListPDF(packingData, undefined, savedVisibleCols);
        } else {
          throw new Error('Êú™Áü•ÁöÑÊñáÊ°£Á±ªÂûã');
        }
      }

      // ‰∏ãËΩΩPDF
      const url = URL.createObjectURL(pdfBlob);
      const link = document.createElement('a');
      link.href = url;
      
      // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÊñá‰ª∂Âêç
      let fileName = 'export.pdf';
      if (itemType === 'quotation') {
        fileName = `QTN_${item.quotationNo || 'export'}.pdf`;
      } else if (itemType === 'confirmation') {
        fileName = `SC_${item.quotationNo || 'export'}.pdf`;
      } else if (itemType === 'invoice') {
        fileName = `INV_${item.invoiceNo || 'export'}.pdf`;
      } else if (itemType === 'purchase') {
        fileName = `PO_${item.orderNo || 'export'}.pdf`;
      } else if (itemType === 'packing') {
        fileName = `PL_${item.orderNo || 'export'}.pdf`;
      }
      
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('PDF‰∏ãËΩΩÂ§±Ë¥•:', error);
      alert('PDF‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    } finally {
      setIsGeneratingPdf(false);
    }
  };

  // Âú®Êñ∞Á™óÂè£ÊâìÂºÄPDF
  const openInNewTab = () => {
    if (pdfPreviewUrl) {
      openPDFInNewTab(pdfPreviewUrl);
    }
  };

  // Ëé∑ÂèñÈ¢ÑËßàÊ†áÈ¢ò
  const getPreviewTitle = () => {
    switch (itemType) {
      case 'quotation':
        return 'Êä•‰ª∑ÂçïÈ¢ÑËßà';
      case 'confirmation':
        return 'ËÆ¢ÂçïÁ°ÆËÆ§È¢ÑËßà';
      case 'invoice':
        return 'ÂèëÁ•®È¢ÑËßà';
      case 'purchase':
        return 'ÈááË¥≠ÂçïÈ¢ÑËßà';
      case 'packing':
        return 'Ë£ÖÁÆ±ÂçïÈ¢ÑËßà';
      default:
        return 'PDFÈ¢ÑËßà';
    }
  };

  // Ê∏ÖÁêÜPDFÈ¢ÑËßàURL
  useEffect(() => {
    return () => {
      if (pdfPreviewUrl) {
        URL.revokeObjectURL(pdfPreviewUrl);
      }
    };
  }, [pdfPreviewUrl]);

  // ÂΩìÊ®°ÊÄÅÊ°ÜÊâìÂºÄÊó∂ÁîüÊàêPDF
  useEffect(() => {
    if (isOpen && item && item.data) {
      generatePdfPreview();
    }
  }, [isOpen, item, itemType, generatePdfPreview]);

  if (!isOpen) return null;

  // ÂÆâÂçìËÆæÂ§á‰∏ìÁî®ÁÆÄÂåñÁïåÈù¢
  if (deviceInfo?.isAndroid) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden">
          {/* ÁÆÄÂåñÁöÑÂ§¥ÈÉ® */}
          <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700">
            <div className="flex items-center gap-2">
              <Smartphone className="w-5 h-5 text-blue-600 dark:text-blue-400" />
              <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                {getPreviewTitle()}
              </h3>
            </div>
            <button
              onClick={onClose}
              className="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full transition-colors"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          
          {/* ÂÜÖÂÆπÂå∫Âüü */}
          <div className="p-6">
            {isGeneratingPdf ? (
              <div className="text-center py-8">
                <div className="animate-spin rounded-full h-10 w-10 border-3 border-blue-200 border-t-blue-600 mx-auto mb-4"></div>
                <p className="text-sm font-medium text-gray-900 dark:text-white">Ê≠£Âú®ÁîüÊàêPDF...</p>
              </div>
            ) : (
              <div className="text-center">
                <div className="w-16 h-16 mx-auto mb-4 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                  <FileText className="w-8 h-8 text-blue-600 dark:text-blue-400" />
                </div>
                
                <h4 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                  PDFÂ∑≤ÂáÜÂ§áÂ∞±Áª™
                </h4>
                
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-6">
                  ÈÄâÊã©ÊÇ®ÁöÑÊü•ÁúãÊñπÂºè
                </p>
                
                {/* ‰∏ªÊìç‰ΩúÊåâÈíÆ */}
                <div className="space-y-3">
                  {/* Êé®ËçêÊìç‰Ωú - Êñ∞Á™óÂè£ÊâìÂºÄ */}
                  {pdfPreviewUrl && deviceInfo?.browser?.name === 'Chrome' && (
                    <button
                      onClick={openInNewTab}
                      className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium shadow-lg"
                    >
                      <ExternalLink className="w-5 h-5" />
                      <span>ÊµèËßàÂô®‰∏≠Êü•Áúã</span>
                      <span className="px-2 py-0.5 bg-blue-500 text-xs rounded-full">Êé®Ëçê</span>
                    </button>
                  )}
                  
                  {/* ‰∏ãËΩΩÊåâÈíÆ */}
                  <button
                    onClick={downloadPDF}
                    disabled={isGeneratingPdf}
                    className={`w-full flex items-center justify-center gap-3 px-6 py-4 rounded-xl font-medium transition-colors shadow-md ${
                      deviceInfo?.browser?.name === 'Chrome' 
                        ? 'border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700' 
                        : 'bg-green-600 text-white hover:bg-green-700 shadow-lg'
                    } disabled:opacity-50 disabled:cursor-not-allowed`}
                  >
                    {isGeneratingPdf ? (
                      <>
                        <div className="animate-spin rounded-full h-5 w-5 border-2 border-current border-t-transparent"></div>
                        <span>ÁîüÊàê‰∏≠...</span>
                      </>
                    ) : (
                      <>
                        <Download className="w-5 h-5" />
                        <span>‰∏ãËΩΩÂà∞ÊâãÊú∫</span>
                        {deviceInfo?.browser?.name !== 'Chrome' && (
                          <span className="px-2 py-0.5 bg-green-500 text-xs rounded-full">Êé®Ëçê</span>
                        )}
                      </>
                    )}
                  </button>
                  
                  {/* Â§áÁî®ÈÄâÈ°π - Âè™ÊúâÂú®Chrome‰∏≠ÊâçÊòæÁ§∫ */}
                  {pdfPreviewUrl && deviceInfo?.browser?.name === 'Chrome' && (
                    <button
                      onClick={downloadPDF}
                      disabled={isGeneratingPdf}
                      className="w-full flex items-center justify-center gap-3 px-6 py-3 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm"
                    >
                      <Download className="w-4 h-4" />
                      <span>ÊàñËÄÖ‰∏ãËΩΩÂà∞ÊâãÊú∫</span>
                    </button>
                  )}
                </div>
                
                {/* ÁÆÄÂåñÁöÑÊèêÁ§∫‰ø°ÊÅØ */}
                {deviceInfo?.browser?.name !== 'Chrome' && (
                  <div className="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                    <p className="text-xs text-amber-700 dark:text-amber-400 flex items-center gap-2">
                      <span>üí°</span>
                      <span>Âª∫ËÆÆ‰ΩøÁî®ChromeÊµèËßàÂô®‰ª•Ëé∑ÂæóÊõ¥Â•ΩÁöÑÈ¢ÑËßà‰ΩìÈ™å</span>
                    </p>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Ê°åÈù¢Á´ØÁïåÈù¢‰øùÊåÅÂéüÊ†∑
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-hidden">
        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <div className="flex items-center gap-3">
            <h3 className="text-xl font-semibold text-gray-900 dark:text-white">
              {getPreviewTitle()}
            </h3>
          </div>
          <div className="flex items-center gap-2">
            {/* Êñ∞Á™óÂè£ÊâìÂºÄÊåâÈíÆ */}
            {pdfPreviewUrl && (
              <button
                onClick={openInNewTab}
                className="p-2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
                title="Âú®Êñ∞Á™óÂè£ÊâìÂºÄ"
              >
                <ExternalLink className="w-5 h-5" />
              </button>
            )}
            
            {/* ‰∏ãËΩΩÊåâÈíÆ */}
            <button
              onClick={downloadPDF}
              disabled={isGeneratingPdf}
              className="p-2 text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors disabled:opacity-50"
              title="‰∏ãËΩΩPDF"
            >
              <Download className={`w-5 h-5 ${isGeneratingPdf ? 'animate-pulse' : ''}`} />
            </button>
            
            {/* ÂÖ≥Èó≠ÊåâÈíÆ */}
            <button
              onClick={onClose}
              className="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>
        
        <div className="bg-white dark:bg-gray-800 rounded-b-xl flex items-center justify-center border border-gray-200 dark:border-gray-600" style={{padding:0}}>
          {isGeneratingPdf ? (
            <div className="flex flex-col items-center space-y-4 py-12">
              <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-200 border-t-blue-600"></div>
              <div className="text-center">
                <p className="text-sm font-medium text-gray-900 dark:text-white">Ê≠£Âú®ÁîüÊàêPDFÈ¢ÑËßà...</p>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">ËØ∑Á®çÂÄô</p>
              </div>
            </div>
          ) : showDownloadFallback ? (
            <div className="text-center py-12 px-6 max-w-lg mx-auto">
              <FileText className="w-16 h-16 mx-auto mb-4 text-blue-500 opacity-70" />
              <h4 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                PDFÈ¢ÑËßà
              </h4>
              <p className="text-sm text-gray-500 dark:text-gray-400 mb-6">
                {previewInfo?.message || 'ÈÄâÊã©ÊÇ®ÂÅèÂ•ΩÁöÑPDFÊü•ÁúãÊñπÂºè'}
              </p>
              
              <div className="flex flex-col sm:flex-row gap-3 justify-center">
                {/* Êé®ËçêÊìç‰ΩúÊåâÈíÆ */}
                {deviceInfo?.recommendedAction === 'newTab' && pdfPreviewUrl && (
                  <button
                    onClick={openInNewTab}
                    className="flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <ExternalLink className="w-4 h-4" />
                    <span>Êñ∞Á™óÂè£ÊâìÂºÄ (Êé®Ëçê)</span>
                  </button>
                )}
                
                <button
                  onClick={downloadPDF}
                  disabled={isGeneratingPdf}
                  className={`flex items-center justify-center gap-2 px-6 py-3 rounded-lg transition-colors ${
                    deviceInfo?.recommendedAction === 'download' 
                      ? 'bg-blue-600 text-white hover:bg-blue-700' 
                      : 'border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                  } disabled:opacity-50 disabled:cursor-not-allowed`}
                >
                  {isGeneratingPdf ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                      <span>ÁîüÊàê‰∏≠...</span>
                    </>
                  ) : (
                    <>
                      <Download className="w-4 h-4" />
                      <span>‰∏ãËΩΩPDF {deviceInfo?.recommendedAction === 'download' ? '(Êé®Ëçê)' : ''}</span>
                    </>
                  )}
                </button>
                
                {deviceInfo?.recommendedAction !== 'newTab' && pdfPreviewUrl && (
                  <button
                    onClick={openInNewTab}
                    className="flex items-center justify-center gap-2 px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                  >
                    <ExternalLink className="w-4 h-4" />
                    <span>Êñ∞Á™óÂè£ÊâìÂºÄ</span>
                  </button>
                )}
              </div>
            </div>
          ) : pdfPreviewUrl ? (
            <iframe
              src={pdfPreviewUrl}
              className="w-full h-[80vh] border-0 rounded-b-xl"
              title="PDFÈ¢ÑËßà"
              style={{margin:0, padding:0}}
              onError={() => setShowDownloadFallback(true)}
            />
          ) : (
            <div className="text-center text-gray-500 dark:text-gray-400 py-12">
              <FileText className="w-16 h-16 mx-auto mb-4 opacity-50" />
              <p className="text-lg font-medium mb-2">Êó†Ê≥ïÁîüÊàêPDFÈ¢ÑËßà</p>
              <p className="text-sm">ËØ∑Ê£ÄÊü•ËÆ∞ÂΩïÊï∞ÊçÆÊòØÂê¶ÂÆåÊï¥</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
} 