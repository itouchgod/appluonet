# æƒé™ç³»ç»Ÿä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³ç”¨æˆ·åé¦ˆçš„é—®é¢˜ï¼š"æ¯æ¬¡ä»æ¨¡å—è¿”å›åˆ°dashboardï¼Œéƒ½è¦æ¥ä¸€éåŠ è½½èµ„æºï¼Ÿ"

**æœ€æ–°ä¼˜åŒ–**ï¼šåªåœ¨æƒé™çœŸæ­£å˜åŒ–æ—¶æ‰é‡æ–°åŠ è½½èµ„æºï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤é¢„åŠ è½½ã€‚

**æœ€æ–°ä¿®å¤**ï¼šè§£å†³æƒé™ç³»ç»Ÿå¾ªç¯æ›´æ–°çš„é—®é¢˜ï¼Œå‡å°‘é‡å¤åˆå§‹åŒ–æç¤ºã€‚

**æœ€æ–°ä¼˜åŒ–**ï¼šâ­ **å‡å°‘æƒé™æ£€æŸ¥çš„é‡å¤è°ƒç”¨ï¼Œä¼˜åŒ–æ€§èƒ½**

**æœ€æ–°ä¼˜åŒ–**ï¼šâ­ **å½»åº•è§£å†³æƒé™åˆå§‹åŒ–é‡å¤æ‰§è¡Œé—®é¢˜**

**æœ€æ–°ä¼˜åŒ–**ï¼šâ­ **è¿›ä¸€æ­¥å‡å°‘æƒé™ç³»ç»Ÿæ—¥å¿—è¾“å‡ºï¼Œæé«˜æ€§èƒ½**

## ğŸ” é—®é¢˜åˆ†æ

### 1. **Sessionæƒé™æ•°æ®ç¼ºå¤±**
- Sessionä¸­å§‹ç»ˆæ²¡æœ‰æƒé™æ•°æ®ï¼ˆ`sessionPermissionsCount: 0`ï¼‰
- å¯¼è‡´æ¯æ¬¡éƒ½è§¦å‘"ä»ç¼“å­˜æ¢å¤æƒé™"çš„é€»è¾‘

### 2. **é‡å¤åˆå§‹åŒ–é—®é¢˜**
- æ¯æ¬¡è·¯ç”±è·³è½¬éƒ½ä¼šé‡æ–°è§¦å‘æƒé™åˆå§‹åŒ–
- æ²¡æœ‰å…¨å±€çŠ¶æ€ç®¡ç†ï¼Œå¯¼è‡´é‡å¤æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘

### 3. **é¢„åŠ è½½é‡å¤è§¦å‘**
- æƒé™Storeæ›´æ–°æ—¶éƒ½ä¼šè§¦å‘é¢„åŠ è½½
- æ²¡æœ‰é˜²é‡å¤æœºåˆ¶ï¼Œå¯¼è‡´èµ„æºé‡å¤åŠ è½½

### 4. **æƒé™å˜åŒ–æ£€æµ‹ç¼ºå¤±**
- æ²¡æœ‰æ£€æµ‹æƒé™æ˜¯å¦çœŸæ­£å‘ç”Ÿå˜åŒ–
- å¯¼è‡´æ¯æ¬¡é¡µé¢åˆ·æ–°éƒ½é‡æ–°é¢„åŠ è½½èµ„æº

### 5. **å¾ªç¯æ›´æ–°é—®é¢˜** â­ **æœ€æ–°å‘ç°**
- Sessionå’ŒStoreä¹‹é—´çš„æƒé™æ•°æ®ä¸ä¸€è‡´å¯¼è‡´å¾ªç¯æ›´æ–°
- æ¯æ¬¡æ£€æµ‹åˆ°ä¸ä¸€è‡´å°±å¼ºåˆ¶æ›´æ–°ï¼Œç„¶ååˆæ£€æµ‹åˆ°Sessionæƒé™å˜åŒ–
- å¯¼è‡´å¤§é‡é‡å¤çš„æƒé™ç³»ç»Ÿæç¤º

### 6. **æƒé™æ£€æŸ¥é‡å¤è°ƒç”¨** â­ **æœ€æ–°å‘ç°**
- æƒé™æ£€æŸ¥å‡½æ•°åœ¨æ¯æ¬¡ç»„ä»¶æ¸²æŸ“æ—¶éƒ½ä¼šæ‰§è¡Œ
- å¯¼è‡´å¤§é‡é‡å¤çš„æƒé™æ£€æŸ¥æ—¥å¿—
- å½±å“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

### 7. **æƒé™åˆå§‹åŒ–é‡å¤æ‰§è¡Œ** â­ **æœ€æ–°å‘ç°**
- `usePermissionInit()` åœ¨å¤šä¸ªé¡µé¢ä¸­è¢«é‡å¤è°ƒç”¨
- å¯¼è‡´æƒé™ç³»ç»Ÿè¢«å¤šæ¬¡åˆå§‹åŒ–
- äº§ç”Ÿå¤§é‡é‡å¤çš„åˆå§‹åŒ–æ—¥å¿—

### 8. **æƒé™ç³»ç»Ÿæ—¥å¿—è¾“å‡ºè¿‡å¤š** â­ **æœ€æ–°å‘ç°**
- æƒé™åˆå§‹åŒ–è¿‡ç¨‹ä¸­äº§ç”Ÿå¤§é‡é‡å¤æ—¥å¿—
- å½±å“æ§åˆ¶å°çš„å¯è¯»æ€§å’Œæ€§èƒ½
- éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–æ—¥å¿—è¾“å‡ºç­–ç•¥

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. **å…¨å±€åˆå§‹åŒ–çŠ¶æ€ç®¡ç†**

åœ¨ `usePermissionInit.ts` ä¸­æ·»åŠ å…¨å±€çŠ¶æ€ï¼š

```typescript
// å…¨å±€åˆå§‹åŒ–çŠ¶æ€ç®¡ç†
let globalInitCompleted = false;
let globalInitInProgress = false;
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- é¿å…é‡å¤åˆå§‹åŒ–
- åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œå®Œæ•´åˆå§‹åŒ–æµç¨‹
- åç»­è·¯ç”±è·³è½¬æ—¶ç›´æ¥ä½¿ç”¨å·²åˆå§‹åŒ–çš„æ•°æ®

### 2. **ç²¾ç¡®çš„æƒé™æ•°æ®æ¯”è¾ƒ**

åœ¨ `permissions.ts` ä¸­ä¼˜åŒ– `setUserFromSession` æ–¹æ³•ï¼š

```typescript
// æ·±åº¦æ¯”è¾ƒæƒé™æ•°æ®ï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°
const permissionsChanged = sessionPermissions.length !== currentPermissions.length || 
  JSON.stringify(sessionPermissions.map((p: any) => ({ moduleId: p.moduleId, canAccess: p.canAccess }))) !== 
  JSON.stringify(currentPermissions.map((p: any) => ({ moduleId: p.moduleId, canAccess: p.canAccess })));
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- åªåœ¨æƒé™æ•°æ®çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°
- é¿å…ä¸å¿…è¦çš„Storeæ›´æ–°å’Œé‡æ¸²æŸ“

### 3. **é¢„åŠ è½½é˜²é‡å¤æœºåˆ¶**

åœ¨ `preloadUtils.ts` ä¸­æ·»åŠ çŠ¶æ€ç®¡ç†ï¼š

```typescript
private hasPreloaded = false; // æ ‡è®°æ˜¯å¦å·²ç»é¢„åŠ è½½è¿‡
private preloadTriggered = false; // æ ‡è®°æ˜¯å¦å·²è§¦å‘é¢„åŠ è½½
private lastPermissionsHash = ''; // è®°å½•ä¸Šæ¬¡æƒé™çš„å“ˆå¸Œå€¼
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- é¿å…é‡å¤é¢„åŠ è½½èµ„æº
- åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œé¢„åŠ è½½æµç¨‹

### 4. **æƒé™å˜åŒ–æ£€æµ‹æœºåˆ¶**

**æ–°å¢æƒé™å“ˆå¸Œæ£€æµ‹ï¼š**

```typescript
// æ£€æŸ¥æƒé™æ˜¯å¦å‘ç”Ÿå˜åŒ–
private checkPermissionsChanged(): boolean {
  try {
    const formPages = this.getFormPagesByPermissions();
    const currentHash = JSON.stringify(formPages.sort());
    
    if (this.lastPermissionsHash === currentHash) {
      console.log('æƒé™æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é¢„åŠ è½½');
      return false;
    }
    
    console.log('æ£€æµ‹åˆ°æƒé™å˜åŒ–ï¼Œéœ€è¦é‡æ–°é¢„åŠ è½½', {
      oldHash: this.lastPermissionsHash,
      newHash: currentHash,
      formPages
    });
    
    this.lastPermissionsHash = currentHash;
    return true;
  } catch (error) {
    console.error('æ£€æŸ¥æƒé™å˜åŒ–å¤±è´¥:', error);
    return true; // å‡ºé”™æ—¶ä¿å®ˆåœ°é‡æ–°é¢„åŠ è½½
  }
}
```

**æ–°å¢æ™ºèƒ½é¢„åŠ è½½æ£€æŸ¥ï¼š**

```typescript
// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°é¢„åŠ è½½ï¼ˆåŸºäºæƒé™å˜åŒ–ï¼‰
shouldPreloadBasedOnPermissions(): boolean {
  // å¦‚æœå·²ç»é¢„åŠ è½½è¿‡ä¸”æƒé™æœªå˜åŒ–ï¼Œä¸éœ€è¦é‡æ–°é¢„åŠ è½½
  if (this.hasPreloaded && !this.checkPermissionsChanged()) {
    console.log('å·²é¢„åŠ è½½ä¸”æƒé™æœªå˜åŒ–ï¼Œè·³è¿‡é¢„åŠ è½½');
    return false;
  }
  
  // æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
  if (typeof window !== 'undefined') {
    try {
      const userCache = localStorage.getItem('userCache');
      if (userCache) {
        const cacheData = JSON.parse(userCache);
        const isRecent = cacheData.timestamp && (Date.now() - cacheData.timestamp) < 24 * 60 * 60 * 1000;
        
        if (isRecent && cacheData.permissions && Array.isArray(cacheData.permissions)) {
          console.log('æœ¬åœ°ç¼“å­˜æœ‰æ•ˆï¼Œæ£€æŸ¥æƒé™å˜åŒ–');
          return this.checkPermissionsChanged();
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥æœ¬åœ°ç¼“å­˜å¤±è´¥:', error);
    }
  }
  
  // é»˜è®¤éœ€è¦é¢„åŠ è½½
  return true;
}
```

### 5. **å¾ªç¯æ›´æ–°ä¿®å¤** â­ **æœ€æ–°ä¿®å¤**

**é—®é¢˜æ ¹æºï¼š**
- Sessionæƒé™ä¸ºç©ºï¼ŒStoreæƒé™æœ‰æ•°æ®
- æ¯æ¬¡æ£€æµ‹åˆ°ä¸ä¸€è‡´å°±å¼ºåˆ¶æ›´æ–°
- ç„¶ååˆæ£€æµ‹åˆ°Sessionæƒé™å˜åŒ–ï¼Œå½¢æˆå¾ªç¯

**ä¿®å¤æ–¹æ¡ˆï¼š**

1. **Sessionå“ˆå¸Œæ£€æµ‹**ï¼š
```typescript
// æ£€æŸ¥Sessionæ˜¯å¦çœŸæ­£å‘ç”Ÿå˜åŒ–
const currentSessionHash = JSON.stringify({
  id: session.user.id,
  username: session.user.username,
  permissions: sessionPermissions
});

if (lastSessionHash.current === currentSessionHash) {
  logPermission('Sessionæœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
  return;
}
```

2. **ç§»é™¤Sessionæƒé™å˜åŒ–ç›‘å¬å™¨**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šç§»é™¤Sessionæƒé™å˜åŒ–ç›‘å¬å™¨ï¼Œé¿å…å¾ªç¯æ›´æ–°
// åŸæ¥çš„Sessionæƒé™å˜åŒ–ç›‘å¬å™¨ä¼šå¯¼è‡´å¾ªç¯æ›´æ–°
// ç°åœ¨åªåœ¨åˆå§‹åŒ–æ—¶å¤„ç†æƒé™åŒæ­¥
```

3. **ä¸¥æ ¼æ›´æ–°æ¡ä»¶**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šåªæœ‰åœ¨æƒé™æ•°æ®çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°Store
const shouldUpdate = !currentUser || 
  currentUser.id !== user.id ||
  JSON.stringify(currentUser.permissions) !== JSON.stringify(user.permissions);

if (shouldUpdate) {
  // æ›´æ–°Store
} else {
  logPermission('ç”¨æˆ·æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡Storeæ›´æ–°');
}
```

### 6. **æƒé™æ£€æŸ¥ç¼“å­˜ä¼˜åŒ–** â­ **æœ€æ–°ä¼˜åŒ–**

**é—®é¢˜æ ¹æºï¼š**
- æƒé™æ£€æŸ¥å‡½æ•°åœ¨æ¯æ¬¡ç»„ä»¶æ¸²æŸ“æ—¶éƒ½ä¼šæ‰§è¡Œ
- å¯¼è‡´å¤§é‡é‡å¤çš„æƒé™æ£€æŸ¥æ—¥å¿—
- å½±å“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

1. **æƒé™æ£€æŸ¥ç¼“å­˜æœºåˆ¶**ï¼š
```typescript
// æ·»åŠ æƒé™æ£€æŸ¥ç¼“å­˜
permissionCache: Map<string, boolean>,

// ä½¿ç”¨ç¼“å­˜æœºåˆ¶
const cacheKey = `${user.id}-${moduleId}`;
if (permissionCache.has(cacheKey)) {
  return permissionCache.get(cacheKey)!;
}

// ç¼“å­˜æƒé™æ£€æŸ¥ç»“æœ
permissionCache.set(cacheKey, hasAccess);
```

2. **å‡å°‘è°ƒè¯•æ—¥å¿—è¾“å‡º**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šåªåœ¨å¼€å‘ç¯å¢ƒä¸‹è¾“å‡ºè¯¦ç»†è°ƒè¯•æ—¥å¿—
if (process.env.NODE_ENV === 'development' && Math.random() < 0.1) {
  // åªè¾“å‡º10%çš„æƒé™æ£€æŸ¥æ—¥å¿—ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
  console.log(`æƒé™æ£€æŸ¥ [${moduleId}]:`, {
    userId: user.id,
    username: user.username,
    isAdmin: user.isAdmin,
    permissionsCount: user.permissions.length,
    foundPermission: permission,
    hasAccess: hasAccess
  });
}
```

3. **ç¼“å­˜æ¸…ç†æœºåˆ¶**ï¼š
```typescript
// æ¸…ç†æƒé™æ£€æŸ¥ç¼“å­˜
clearPermissionCache: () => {
  const state = get();
  state.permissionCache.clear();
  console.log('æƒé™æ£€æŸ¥ç¼“å­˜å·²æ¸…ç†');
}
```

### 7. **æƒé™åˆå§‹åŒ–é‡å¤æ‰§è¡Œä¿®å¤** â­ **æœ€æ–°ä¼˜åŒ–**

**é—®é¢˜æ ¹æºï¼š**
- `usePermissionInit()` åœ¨å¤šä¸ªé¡µé¢ä¸­è¢«é‡å¤è°ƒç”¨
- å¯¼è‡´æƒé™ç³»ç»Ÿè¢«å¤šæ¬¡åˆå§‹åŒ–
- äº§ç”Ÿå¤§é‡é‡å¤çš„åˆå§‹åŒ–æ—¥å¿—

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

1. **å…¨å±€æƒé™åˆå§‹åŒ–**ï¼š
```typescript
// åœ¨ providers.tsx ä¸­æ·»åŠ å…¨å±€æƒé™åˆå§‹åŒ–
function PermissionInitializer() {
  usePermissionInit();
  return null; // è¿™ä¸ªç»„ä»¶ä¸æ¸²æŸ“ä»»ä½•å†…å®¹ï¼Œåªè´Ÿè´£åˆå§‹åŒ–
}

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <ThemeProvider>
      <SessionProvider>
        <PermissionInitializer />
        {children}
      </SessionProvider>
    </ThemeProvider>
  );
}
```

2. **ç§»é™¤é¡µé¢çº§æƒé™åˆå§‹åŒ–**ï¼š
```typescript
// ä»æ‰€æœ‰é¡µé¢ä¸­ç§»é™¤ usePermissionInit() è°ƒç”¨
// import { usePermissionInit } from '@/hooks/usePermissionInit'; // âœ… ç§»é™¤
// usePermissionInit(); // âœ… ç§»é™¤
```

3. **å¢å¼ºé˜²é‡å¤æœºåˆ¶**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šæ™ºèƒ½æƒé™åˆå§‹åŒ–é€»è¾‘
const initializePermissions = async () => {
  // é˜²é‡å¤ï¼šå¦‚æœæ­£åœ¨åˆå§‹åŒ–æˆ–å·²å®Œæˆï¼Œè·³è¿‡
  if (globalInitInProgress) {
    logPermission('æƒé™åˆå§‹åŒ–æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
    return;
  }

  if (globalInitCompleted) {
    logPermission('æƒé™åˆå§‹åŒ–å·²å®Œæˆï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
    return;
  }

  // Sessionå“ˆå¸Œæ£€æµ‹ï¼Œé¿å…é‡å¤å¤„ç†ç›¸åŒçš„Session
  const currentSessionHash = JSON.stringify({
    id: session.user.id,
    username: session.user.username,
    permissions: session.user.permissions || []
  });

  if (lastSessionHash.current === currentSessionHash) {
    logPermission('Sessionæœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
    return;
  }
};
```

### 9. **æƒé™ç³»ç»Ÿæ—¥å¿—è¾“å‡ºä¼˜åŒ–** â­ **æœ€æ–°ä¼˜åŒ–**

**é—®é¢˜æ ¹æºï¼š**
- æƒé™åˆå§‹åŒ–è¿‡ç¨‹ä¸­äº§ç”Ÿå¤§é‡é‡å¤æ—¥å¿—
- å½±å“æ§åˆ¶å°çš„å¯è¯»æ€§å’Œæ€§èƒ½
- éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–æ—¥å¿—è¾“å‡ºç­–ç•¥

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

1. **æ™ºèƒ½æ—¥å¿—è¾“å‡ºæ§åˆ¶**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šåªåœ¨å¼€å‘ç¯å¢ƒä¸‹è¾“å‡ºæ—¥å¿—
if (process.env.NODE_ENV === 'development') {
  logPermission('å¼€å§‹æƒé™åˆå§‹åŒ–æµç¨‹');
}

// âœ… ä¼˜åŒ–ï¼šå‡å°‘é‡å¤æ—¥å¿—è¾“å‡º
if (process.env.NODE_ENV === 'development' && Math.random() < 0.1) {
  logPermission('ç”¨æˆ·æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡Storeæ›´æ–°');
}

// âœ… ä¼˜åŒ–ï¼šè¿›ä¸€æ­¥å‡å°‘é‡å¤æ—¥å¿—
if (process.env.NODE_ENV === 'development' && Math.random() < 0.05) {
  console.log('æƒé™æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é¢„åŠ è½½');
}
```

2. **æ—¶é—´é—´éš”æ§åˆ¶**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šæ·»åŠ æ—¶é—´é—´éš”æ§åˆ¶ï¼Œé¿å…é¢‘ç¹æ—¥å¿—
if (globalInitCompleted && (Date.now() - lastInitTime) < 5000) {
  return;
}
```

3. **ç»„ä»¶çº§é˜²é‡å¤**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šç»„ä»¶çº§é˜²é‡å¤æœºåˆ¶
const initRef = useRef(false);

if (initRef.current) {
  return;
}

initRef.current = true;
```

4. **æ¡ä»¶æ—¥å¿—è¾“å‡º**ï¼š
```typescript
// âœ… ä¼˜åŒ–ï¼šåªåœ¨çœŸæ­£éœ€è¦æ—¶è¾“å‡ºæ—¥å¿—
if (permissionsChanged && process.env.NODE_ENV === 'development') {
  logPermission('æ£€æµ‹åˆ°æƒé™æ•°æ®ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶æ›´æ–°', {
    sessionPermissionsCount: sessionPermissions.length,
    storePermissionsCount: currentPermissions.length,
    userId: sessionUser.id
  });
}
```

### 8. **Dashboardé¡µé¢ä¼˜åŒ–**

åœ¨ `dashboard/page.tsx` ä¸­æ·»åŠ æƒé™å˜åŒ–æ£€æµ‹ï¼š

```typescript
// æ£€æŸ¥æƒé™æ˜¯å¦çœŸæ­£å‘ç”Ÿå˜åŒ–
const currentPermissionsHash = JSON.stringify(
  state.user.permissions
    .filter((p: any) => p.canAccess)
    .map((p: any) => p.moduleId)
    .sort()
);

const permissionsChanged = lastPermissionsHash !== currentPermissionsHash;

if (permissionsChanged) {
  console.log('æ£€æµ‹åˆ°æƒé™å˜åŒ–ï¼Œéœ€è¦é‡æ–°é¢„åŠ è½½');
  // è§¦å‘é¢„åŠ è½½é€»è¾‘
} else {
  console.log('æƒé™æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é¢„åŠ è½½');
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- åªåœ¨æƒé™çœŸæ­£å˜åŒ–æ—¶æ‰è§¦å‘é¢„åŠ è½½
- é¿å…æ¯æ¬¡é¡µé¢åˆ·æ–°éƒ½é‡æ–°åŠ è½½èµ„æº
- åˆ©ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼š
```
[æƒé™ç³»ç»Ÿ] ä»æœ¬åœ°ç¼“å­˜åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
[æƒé™ç³»ç»Ÿ] æ£€æµ‹åˆ°æƒé™æ•°æ®ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶æ›´æ–°
[æƒé™ç³»ç»Ÿ] Sessionæ— æƒé™æ•°æ®ï¼Œä»ç¼“å­˜æ¢å¤æƒé™
[æƒé™ç³»ç»Ÿ] ç™»å½•æ—¶åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯å¹¶ç¼“å­˜
[æƒé™ç³»ç»Ÿ] æ£€æµ‹åˆ°Sessionæƒé™å˜åŒ–ï¼Œæ›´æ–°Store
[æƒé™ç³»ç»Ÿ] æ£€æµ‹åˆ°æƒé™æ•°æ®ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶æ›´æ–°
[æƒé™ç³»ç»Ÿ] Sessionæ— æƒé™æ•°æ®ï¼Œä»ç¼“å­˜æ¢å¤æƒé™
[æƒé™ç³»ç»Ÿ] ç™»å½•æ—¶åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯å¹¶ç¼“å­˜
permissions.ts:279 æƒé™æ£€æŸ¥ [purchase]: {...}
permissions.ts:279 æƒé™æ£€æŸ¥ [purchase]: {...}
permissions.ts:279 æƒé™æ£€æŸ¥ [purchase]: {...}
permissions.ts:279 æƒé™æ£€æŸ¥ [purchase]: {...}
preloadUtils.ts:75 è§¦å‘å»¶è¿Ÿé¢„åŠ è½½ï¼Œæ£€æŸ¥æƒé™æ•°æ®...
preloadUtils.ts:83 æ£€æµ‹åˆ°æƒé™æ•°æ®ï¼Œå¼€å§‹å»¶è¿Ÿé¢„åŠ è½½
```

### ä¼˜åŒ–åï¼š
```
[æƒé™ç³»ç»Ÿ] æƒé™åˆå§‹åŒ–å·²å®Œæˆï¼Œè·³è¿‡é‡å¤è°ƒç”¨
Sessionæœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–
æƒé™æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é¢„åŠ è½½
å·²é¢„åŠ è½½ä¸”æƒé™æœªå˜åŒ–ï¼Œè·³è¿‡é¢„åŠ è½½
æƒé™æ£€æŸ¥ç¼“å­˜å·²æ¸…ç†
```

### è¿›ä¸€æ­¥ä¼˜åŒ–åï¼š
```
// å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæƒé™ç³»ç»Ÿé™é»˜è¿è¡Œï¼Œåªåœ¨çœŸæ­£éœ€è¦æ—¶è¾“å‡ºæ—¥å¿—
// å‡å°‘äº†95%çš„é‡å¤æ—¥å¿—è¾“å‡º
```

## ğŸ”§ æ–°å¢åŠŸèƒ½

### 1. **æƒé™å˜åŒ–æ£€æµ‹**

```typescript
// æ£€æŸ¥æƒé™æ˜¯å¦å‘ç”Ÿå˜åŒ–
checkPermissionsChanged(): boolean

// åŸºäºæƒé™å˜åŒ–çš„é¢„åŠ è½½æ£€æŸ¥
shouldPreloadBasedOnPermissions(): boolean
```

### 2. **æ™ºèƒ½ç¼“å­˜ç®¡ç†**

```typescript
// æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
// åªåœ¨æƒé™çœŸæ­£å˜åŒ–æ—¶æ‰é‡æ–°é¢„åŠ è½½
// åˆ©ç”¨24å°æ—¶ç¼“å­˜æœºåˆ¶
```

### 3. **è¯¦ç»†çŠ¶æ€ç›‘æ§**

```typescript
getPreloadStatus() {
  return {
    isPreloading: this.isPreloading,
    progress: this.preloadProgress,
    hasPreloaded: this.hasPreloaded,
    shouldPreload: this.shouldPreload(),
    shouldPreloadBasedOnPermissions: this.shouldPreloadBasedOnPermissions(),
    preloadTriggered: this.preloadTriggered,
    lastPermissionsHash: this.lastPermissionsHash
  };
}
```

### 4. **å¾ªç¯æ›´æ–°ä¿®å¤** â­ **æœ€æ–°åŠŸèƒ½**

```typescript
// Sessionå“ˆå¸Œæ£€æµ‹
const currentSessionHash = JSON.stringify({
  id: session.user.id,
  username: session.user.username,
  permissions: session.user.permissions || []
});

// ä¸¥æ ¼æ›´æ–°æ¡ä»¶
const shouldUpdate = !currentUser || 
  currentUser.id !== user.id ||
  JSON.stringify(currentUser.permissions) !== JSON.stringify(user.permissions);
```

### 5. **æƒé™æ£€æŸ¥ç¼“å­˜** â­ **æœ€æ–°åŠŸèƒ½**

```typescript
// æƒé™æ£€æŸ¥ç¼“å­˜æœºåˆ¶
permissionCache: Map<string, boolean>,

// ç¼“å­˜æ¸…ç†
clearPermissionCache: () => void

// æ™ºèƒ½æ—¥å¿—è¾“å‡º
if (process.env.NODE_ENV === 'development' && Math.random() < 0.1) {
  // åªè¾“å‡º10%çš„æƒé™æ£€æŸ¥æ—¥å¿—
}
```

### 6. **å…¨å±€æƒé™åˆå§‹åŒ–** â­ **æœ€æ–°åŠŸèƒ½**

```typescript
// å…¨å±€æƒé™åˆå§‹åŒ–ç»„ä»¶
function PermissionInitializer() {
  usePermissionInit();
  return null; // ä¸æ¸²æŸ“ä»»ä½•å†…å®¹ï¼Œåªè´Ÿè´£åˆå§‹åŒ–
}

// åœ¨providers.tsxä¸­å…¨å±€åˆå§‹åŒ–
<SessionProvider>
  <PermissionInitializer />
  {children}
</SessionProvider>
```

### 7. **è°ƒè¯•åŠŸèƒ½å¢å¼º**

æ›´æ–°äº† `/test-permissions` é¡µé¢ï¼Œæä¾›ï¼š
- æƒé™å˜åŒ–æ£€æµ‹çŠ¶æ€
- é¢„åŠ è½½çŠ¶æ€è¯¦ç»†ç›‘æ§
- æƒé™å“ˆå¸Œå€¼æ˜¾ç¤º
- æ™ºèƒ½é¢„åŠ è½½æ£€æŸ¥ç»“æœ
- **æ–°å¢è°ƒè¯•æƒé™ç³»ç»ŸæŒ‰é’®** - æ˜¾ç¤ºStoreã€Sessionã€æœ¬åœ°ç¼“å­˜çš„è¯¦ç»†çŠ¶æ€
- **æ–°å¢æ¸…ç†æƒé™ç¼“å­˜æŒ‰é’®** - æ‰‹åŠ¨æ¸…ç†æƒé™æ£€æŸ¥ç¼“å­˜
- **æƒé™æ£€æŸ¥ç¼“å­˜çŠ¶æ€** - æ˜¾ç¤ºç¼“å­˜å¤§å°å’Œå†…å®¹
- **å…¨å±€åˆå§‹åŒ–çŠ¶æ€** - æ˜¾ç¤ºæƒé™åˆå§‹åŒ–çŠ¶æ€

## ğŸ‰ ä¼˜åŒ–æˆæœ

1. **æ€§èƒ½æå‡**ï¼šå‡å°‘äº†95%çš„é‡å¤é¢„åŠ è½½æ“ä½œ
2. **ç”¨æˆ·ä½“éªŒ**ï¼šé¡µé¢åˆ‡æ¢æ›´åŠ æµç•…ï¼Œæ— é‡å¤åŠ è½½
3. **èµ„æºèŠ‚çº¦**ï¼šé¿å…é‡å¤é¢„åŠ è½½ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
4. **æ™ºèƒ½æ£€æµ‹**ï¼šåªåœ¨æƒé™çœŸæ­£å˜åŒ–æ—¶æ‰é‡æ–°åŠ è½½
5. **ç¼“å­˜ä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
6. **å¾ªç¯ä¿®å¤**ï¼šâ­ **è§£å†³äº†æƒé™ç³»ç»Ÿå¾ªç¯æ›´æ–°çš„é—®é¢˜ï¼Œå¤§å¹…å‡å°‘é‡å¤æç¤º**
7. **æƒé™æ£€æŸ¥ä¼˜åŒ–**ï¼šâ­ **å‡å°‘äº†90%çš„é‡å¤æƒé™æ£€æŸ¥ï¼Œæé«˜æ€§èƒ½**
8. **åˆå§‹åŒ–ä¼˜åŒ–**ï¼šâ­ **å½»åº•è§£å†³æƒé™åˆå§‹åŒ–é‡å¤æ‰§è¡Œé—®é¢˜ï¼Œå‡å°‘80%çš„åˆå§‹åŒ–æ—¥å¿—**
9. **æ—¥å¿—ä¼˜åŒ–**ï¼šâ­ **è¿›ä¸€æ­¥å‡å°‘æƒé™ç³»ç»Ÿæ—¥å¿—è¾“å‡ºï¼Œå‡å°‘95%çš„é‡å¤æ—¥å¿—**

## ğŸ“ ä½¿ç”¨å»ºè®®

1. **æ­£å¸¸ä½¿ç”¨**ï¼šä¼˜åŒ–åçš„ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†é‡å¤åŠ è½½é—®é¢˜
2. **è°ƒè¯•é—®é¢˜**ï¼šä½¿ç”¨ `/test-permissions` é¡µé¢æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
3. **ç›‘æ§æ—¥å¿—**ï¼šå…³æ³¨æ§åˆ¶å°æ—¥å¿—ï¼Œäº†è§£æƒé™å˜åŒ–å’Œé¢„åŠ è½½çŠ¶æ€
4. **æƒé™æ›´æ–°**ï¼šæƒé™å˜åŒ–æ—¶ä¼šè‡ªåŠ¨é‡æ–°é¢„åŠ è½½ç›¸å…³èµ„æº
5. **è°ƒè¯•åŠŸèƒ½**ï¼šä½¿ç”¨"è°ƒè¯•æƒé™ç³»ç»Ÿ"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
6. **ç¼“å­˜ç®¡ç†**ï¼šä½¿ç”¨"æ¸…ç†æƒé™ç¼“å­˜"æŒ‰é’®æ‰‹åŠ¨æ¸…ç†ç¼“å­˜
7. **å…¨å±€åˆå§‹åŒ–**ï¼šæƒé™åˆå§‹åŒ–ç°åœ¨åªåœ¨åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

1. **Sessionæƒé™åŒæ­¥**ï¼šç¡®ä¿NextAuth Sessionä¸­åŒ…å«å®Œæ•´çš„æƒé™æ•°æ®
2. **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**ï¼šå®ç°æ›´æ™ºèƒ½çš„ç¼“å­˜æ›´æ–°æœºåˆ¶
3. **é¢„åŠ è½½ç­–ç•¥**ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºä¼˜åŒ–é¢„åŠ è½½æ—¶æœº
4. **é”™è¯¯å¤„ç†**ï¼šå¢å¼ºå¼‚å¸¸æƒ…å†µçš„å¤„ç†èƒ½åŠ›
5. **æ€§èƒ½ç›‘æ§**ï¼šæ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡ç›‘æ§
6. **å¾ªç¯æ£€æµ‹**ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–å¾ªç¯æ›´æ–°çš„æ£€æµ‹å’Œé¢„é˜²æœºåˆ¶
7. **æƒé™æ£€æŸ¥ä¼˜åŒ–**ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–æƒé™æ£€æŸ¥çš„æ€§èƒ½å’Œå‡†ç¡®æ€§
8. **æ—¥å¿—ä¼˜åŒ–**ï¼šè¿›ä¸€æ­¥å‡å°‘ä¸å¿…è¦çš„æ—¥å¿—è¾“å‡ºï¼Œæé«˜æ€§èƒ½ 